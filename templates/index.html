<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RDR Hosting Reminder</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f9fafb;
      --surface:#ffffff;
      --surface2:#f3f4f6;
      --text:#111827;
      --text-secondary:#374151;
      --primary:#8b5cf6;
      --primary-hover:#7c3aed;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --border:#e5e7eb
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
      min-height:100vh;
      padding-bottom:110px;
    }
    .container{max-width:1280px;margin:0 auto;padding:1.4rem 1rem}

    /* ===== Topbar ===== */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:0.9rem 1rem;
      box-shadow:0 4px 18px rgba(0,0,0,0.05);
      position:sticky; top:12px; z-index:50;
      backdrop-filter: blur(4px);
    }
    .top-left{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(135deg,#8b5cf6,#ec4899);
      color:white;font-weight:800;
      box-shadow:0 8px 20px rgba(139,92,246,.35);
    }
    .title-wrap h1{
      font-size:1.35rem;font-weight:700;line-height:1.1;
      background:linear-gradient(to right,#8b5cf6,#ec4899);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .title-wrap .subtitle{
      font-size:0.85rem;color:var(--text-secondary);
    }

    .top-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      background:var(--surface2);
      border:1px solid var(--border);
      padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;
      color:var(--text-secondary);
    }
    .logout{
      background:var(--danger);color:white;border:none;cursor:pointer;
      padding:7px 12px;border-radius:10px;font-weight:700;font-size:12px;
      text-decoration:none;
    }

    header{text-align:center;margin:1.8rem 0 1.3rem}
    header .subtitle{color:var(--text-secondary);font-size:0.95rem;margin-top:6px}

    .stats-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:1rem;margin:1.5rem 0 2rem;
    }
    .stat-card{
      background:var(--surface);border-radius:14px;padding:1.4rem 1rem;
      border:1px solid var(--border);box-shadow:0 4px 15px rgba(0,0,0,0.05);
      text-align:center;
    }
    .stat-value{font-size:2.2rem;font-weight:700;color:var(--primary)}
    .stat-label{color:var(--text-secondary);font-size:0.85rem;margin-top:0.4rem}

    .card{
      background:var(--surface);border-radius:16px;padding:1.7rem;margin-bottom:1.6rem;
      border:1px solid var(--border);box-shadow:0 4px 20px rgba(0,0,0,0.05);
    }

    .card-head{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:1rem;
    }

    .form-grid{display:grid;grid-template-columns:1fr;gap:1rem;margin-bottom:1.2rem}
    input{
      width:100%;padding:0.95rem;background:#fff;border:1px solid var(--border);
      border-radius:12px;font-size:1rem;
    }
    input:focus{
      outline:none;border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(139,92,246,0.15)
    }

    .btn{
      background:var(--primary);color:white;padding:0.95rem 1.2rem;border:none;border-radius:12px;
      font-weight:600;cursor:pointer;
    }
    .btn:hover{background:var(--primary-hover)}
    .btn-cancel{background:var(--surface2);color:var(--text-secondary)}

    .brand-title{
      font-size:1.4rem;font-weight:700;color:var(--primary);
      margin:2.1rem 0 0.9rem;padding-bottom:0.5rem;border-bottom:3px solid var(--primary)
    }

    table{width:100%;border-collapse:separate;border-spacing:0 0.8rem}
    th{display:none}
    td{
      display:block;width:100%;padding:1rem;background:var(--surface);border-radius:12px;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);position:relative;padding-left:90px;font-size:0.95rem
    }
    td::before{
      content:attr(data-label);position:absolute;left:1rem;top:1rem;font-weight:600;
      color:var(--text-secondary);font-size:0.8rem;text-transform:uppercase;letter-spacing:.05em
    }
    .days{font-weight:700;font-size:1.05rem!important}

    .action-btn{
      padding:0.6rem 1rem;font-size:0.85rem;margin:0.4rem 0.3rem;border-radius:8px;
      width:calc(50% - 0.6rem)
    }
    .btn-edit{background:#8b5cf6;color:white}
    .btn-delete{background:var(--danger);color:white}

    .trigger-fixed{
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      width:90%;max-width:400px;background:linear-gradient(135deg,#8b5cf6,#ec4899);
      color:white;padding:1rem 2rem;border-radius:50px;font-weight:600;
      box-shadow:0 10px 30px rgba(139,92,246,0.4);z-index:1000;text-decoration:none;
      text-align:center;font-size:1.05rem
    }

    footer{text-align:center;margin-top:3rem;padding:2rem 0;color:var(--text-secondary);font-size:0.9rem}
    .k39{font-family:'Courier New',monospace;font-weight:bold;color:var(--primary);letter-spacing:0.2em}

    /* Logs */
    .logs-wrap{
      max-height:420px; overflow:auto; border:1px solid var(--border);
      border-radius:12px; background:var(--surface2);
    }
    .logs{
      width:100%; border-collapse:collapse; font-size:0.92rem;
    }
    .logs th, .logs td{
      padding:0.75rem 0.9rem; text-align:left; border-bottom:1px solid var(--border);
      background:transparent;
    }
    .logs th{
      position:sticky; top:0; background:var(--surface);
      font-size:0.8rem; text-transform:uppercase; letter-spacing:.05em;
      color:var(--text-secondary);
    }
    .log-pill{
      display:inline-flex; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;
      border:1px solid var(--border); background:white;
    }
    .pill-INFO{ color:#2563eb; }
    .pill-WARN{ color:#b45309; }
    .pill-ERROR{ color:#b91c1c; }

    @media(min-width:640px){
      .form-grid{grid-template-columns:repeat(2,1fr)}
      .btn{width:auto;margin:0 0.5rem}
    }
    @media(min-width:768px){
      .form-grid{grid-template-columns:repeat(4,1fr)}
      .stats-grid{grid-template-columns:repeat(4,1fr);gap:1.2rem}
      th{display:table-cell;padding:1.2rem 1.5rem;background:var(--surface2)}
      td{display:table-cell;padding:1.5rem;padding-left:1.5rem}
      td::before{display:none}
      .action-btn{width:auto}
      .trigger-fixed{bottom:30px;right:30px;left:auto;transform:none;width:auto}
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="top-left">
        <div class="logo">R</div>
        <div class="title-wrap">
          <h1>RDR Hosting Reminder</h1>
          <div class="subtitle">Professional hosting expiration management</div>
        </div>
      </div>
      <div class="top-right">
        <span class="badge">ðŸ‘¤ {{ username }}</span>
        <span class="badge">ðŸ•˜ {{ now.strftime('%d %B %Y - %H:%M WIB') }}</span>
        <a class="logout" href="/logout">Logout</a>
      </div>
    </div>

    <header>
      <p class="subtitle">
        Total: {{ subs|length }} active subscription{{ 's' if subs|length != 1 else '' }}
      </p>
    </header>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value">{{ subs|length }}</div><div class="stat-label">Total</div></div>
      <div class="stat-card"><div class="stat-value">{{ grouped|length }}</div><div class="stat-label">Brands</div></div>
      <div class="stat-card"><div class="stat-value">{{ expiring_soon }}</div><div class="stat-label">Expiring Soon</div></div>
      <div class="stat-card"><div class="stat-value">{{ expired_count }}</div><div class="stat-label">Expired</div></div>
    </div>

    <!-- ADD / EDIT FORM -->
    <div class="card">
      <div class="card-head">
        <h2 id="form-title">Add New Subscription</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <span class="badge">Timezone: Asia/Jakarta</span>
          <span class="badge">Telegram Alerts: ON</span>
        </div>
      </div>

      <form id="subscription-form" method="post" action="/add">
        <div class="form-grid">
          <input type="text" id="name" name="name" placeholder="Service Name" required>
          <input type="url" id="url" name="url" placeholder="URL" required>
          <input type="text" id="brand" name="brand" placeholder="Brand Domain (contoh: RADAR138, K39, USR)" required>
          <input type="text" id="expires_at" name="expires_at" placeholder="Expire Date (mm/dd/yyyy)" required>
        </div>
        <div style="display:flex;gap:1rem;flex-wrap:wrap">
          <button type="submit" class="btn">Save Subscription</button>
          <button type="button" class="btn btn-cancel" onclick="resetForm()">Cancel Edit</button>
        </div>
      </form>
    </div>

    <!-- ACTIVE SUBS -->
    <div class="card">
      <div class="cta card-head">
        <h2>Active Subscriptions</h2>
        <input id="search" type="text" placeholder="Search service / brand..." style="max-width:260px">
      </div>

      {% if subs %}
        {% for brand, items in grouped.items() %}
          <div class="brand-title">{{ brand or "No Brand" }}</div>
          <table class="subs-table">
            <thead>
              <tr>
                <th>No</th><th>Service</th><th>Brand</th><th>URL</th><th>Expire Date</th><th>Days Left</th><th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for sub in items %}
                {% set days = (sub.expires_at - today).days %}
                <tr class="row">
                  <td data-label="No">{{ loop.index }}</td>
                  <td data-label="Service"><strong>{{ sub.name }}</strong></td>
                  <td data-label="Brand"><strong>{{ sub.brand or "â€“" }}</strong></td>
                  <td data-label="URL">
                    <a href="{{ sub.url }}" target="_blank" style="color:var(--primary)">{{ sub.url }}</a>
                  </td>
                  <td data-label="Expire">{{ sub.expires_at.strftime('%d %B %Y') }}</td>
                  <td data-label="Days Left" class="days"
                      style="color:
                        {% if days <= 3 %}var(--danger)
                        {% elif days <= 7 %}var(--warning)
                        {% else %}var(--success)
                        {% endif %}">
                    {{ days }} day{{ '' if days == 1 else 's' }}
                  </td>
                  <td data-label="Action">
                    <button class="btn action-btn btn-edit"
                      onclick='editSubscription({{ sub.id }}, "{{ sub.name|e }}", "{{ sub.url }}", "{{ sub.brand or ""|e }}", "{{ sub.expires_at.strftime("%m/%d/%Y") }}")'>
                      Edit
                    </button>
                    <form method="post" action="/delete/{{ sub.id }}" style="display:inline">
                      <button type="submit" class="btn action-btn btn-delete"
                        onclick="return confirm('Delete this subscription?')">
                        Delete
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endfor %}
      {% else %}
        <p style="text-align:center;color:var(--text-secondary);padding:4rem 0">
          No active subscriptions yet. Add your first one above.
        </p>
      {% endif %}
    </div>

    <!-- LOGS -->
    <div class="card">
      <div class="card-head">
        <h2>Logs Terbaru</h2>
        <span class="badge">Last 200 events</span>
      </div>

      {% if logs %}
        <div class="logs-wrap">
          <table class="logs">
            <thead>
              <tr>
                <th>Waktu</th>
                <th>Level</th>
                <th>Pesan</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
                <tr>
                  <td style="white-space:nowrap">
                    {{ log.created_at.strftime('%d %b %Y %H:%M') }}
                  </td>
                  <td>
                    <span class="log-pill pill-{{ log.level }}">{{ log.level }}</span>
                  </td>
                  <td>{{ log.message }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p style="color:var(--text-secondary)">Belum ada logs.</p>
      {% endif %}
    </div>

    <a href="/trigger" class="trigger-fixed">Send List to Telegram</a>

    <footer><div class="k39">K39</div></footer>
  </div>

  <script>
    function editSubscription(id, name, url, brand, expires_at){
      document.getElementById('form-title').innerText = 'Edit Subscription';
      document.getElementById('name').value = name;
      document.getElementById('url').value = url;
      document.getElementById('brand').value = brand;
      document.getElementById('expires_at').value = expires_at;
      document.getElementById('subscription-form').action = `/update/${id}`;
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function resetForm(){
      document.getElementById('form-title').innerText='Add New Subscription';
      document.getElementById('subscription-form').reset();
      document.getElementById('subscription-form').action='/add';
    }

    // Simple client-side search (optional)
    const search = document.getElementById("search");
    if(search){
      search.addEventListener("input", () => {
        const q = search.value.toLowerCase();
        document.querySelectorAll(".row").forEach(r => {
          r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
        });
      });
    }
  </script>
</body>
</html>
