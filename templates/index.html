<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RDR Hosting Reminder</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Corporate palette */
      --bg: #f5f7fb;
      --surface: #ffffff;
      --surface-muted: #f1f4f9;
      --text: #0b1220;
      --text-secondary: #5b6472;
      --primary: #2563eb;
      --primary-2:#0ea5e9;
      --success:#16a34a;
      --warning:#f59e0b;
      --danger:#ef4444;
      --border:#e5e9f2;
      --radius:14px;
      --shadow: 0 6px 20px rgba(11,18,32,0.06);
      --shadow-soft: 0 3px 10px rgba(11,18,32,0.05);
    }

    *{ margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height:1.55;
      min-height:100vh;
      padding-bottom:110px;
    }
    .container{ max-width:1280px; margin:0 auto; padding:1rem; }

    /* ===== TOPBAR ===== */
    .topbar{
      position: sticky; top:10px; z-index:50;
      background: var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:0.75rem 0.9rem;
      box-shadow: var(--shadow);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      backdrop-filter: blur(4px);
    }
    .top-left{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:38px; height:38px; border-radius:10px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, #0b1220, #1f2a44);
      color:#fff; font-weight:800; font-size:0.95rem;
      box-shadow: 0 8px 18px rgba(11,18,32,0.25);
      letter-spacing:.02em;
    }
    .title-wrap h1{
      font-size:1.12rem; font-weight:800; letter-spacing:.02em;
      color: var(--text);
    }
    .title-wrap .subtitle{
      font-size:0.78rem; color: var(--text-secondary); margin-top:2px;
    }

    .top-right{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      background: var(--surface-muted);
      border:1px solid var(--border);
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:700; color: var(--text-secondary);
      white-space:nowrap;
    }

    /* Dropdown actions */
    .menu{
      position:relative;
    }
    .menu-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      background:#0b1220; color:#fff;
      border:none; border-radius:10px;
      font-size:12px; font-weight:800; cursor:pointer;
      box-shadow: var(--shadow-soft);
    }
    .menu-btn svg{ width:14px;height:14px; }
    .menu-list{
      position:absolute; right:0; top:110%;
      width:220px; background:var(--surface);
      border:1px solid var(--border); border-radius:12px;
      box-shadow: var(--shadow);
      padding:6px; display:none;
    }
    .menu.open .menu-list{ display:block; }
    .menu-item{
      display:flex; align-items:center; gap:8px;
      padding:9px 10px; border-radius:10px;
      font-size:13px; font-weight:700; color:var(--text);
      text-decoration:none; cursor:pointer;
    }
    .menu-item:hover{ background:var(--surface-muted); }
    .menu-item svg{ width:15px;height:15px; color:#0b1220; }
    .menu-sep{ height:1px; background:var(--border); margin:6px 4px; }

    .logout{
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 10px; border-radius:10px;
      background: #ef4444; color:#fff; font-size:12px; font-weight:800;
      text-decoration:none; box-shadow: var(--shadow-soft);
    }
    .logout svg{ width:14px;height:14px; }

    /* ===== Stats ===== */
    header{ margin:1.1rem 0 0.75rem; }
    .subtle{ color:var(--text-secondary); font-size:0.92rem; }

    .stats-grid{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:.9rem; margin:0.8rem 0 1.2rem;
    }
    .stat-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:14px;
      padding:1rem;
      box-shadow: var(--shadow-soft);
      display:flex; align-items:center; gap:12px;
    }
    .stat-icon{
      width:44px;height:44px;border-radius:12px;
      display:grid;place-items:center;
      background: #0b1220;
      color:#fff;font-weight:800;
      font-size:1rem;
    }
    .stat-value{ font-size:1.6rem; font-weight:800; color:var(--text); }
    .stat-label{ font-size:0.8rem; color:var(--text-secondary); font-weight:700; }

    /* ===== Cards ===== */
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:1.15rem;
      box-shadow: var(--shadow-soft);
      margin-bottom:1rem;
    }
    .card-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap; margin-bottom:.75rem;
    }
    .card-head h2{ font-size:1.05rem; font-weight:800; letter-spacing:.01em; }

    /* ===== Form ===== */
    .form-grid{
      display:grid; grid-template-columns:1fr; gap:.65rem; margin-bottom:.8rem;
    }
    input{
      width:100%; padding:0.78rem 0.85rem;
      background:#fff; border:1px solid var(--border);
      border-radius:12px; font-size:0.95rem;
      outline:none;
    }
    input:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37,99,235,0.12);
    }
    input[type="date"]{ font-weight:700; }

    .quick-row{
      display:flex; gap:6px; flex-wrap:wrap; margin:2px 0 8px;
    }
    .quick-btn{
      appearance:none; border:1px dashed var(--border); background:var(--surface-muted);
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800;
      color:var(--text-secondary); cursor:pointer;
    }
    .quick-btn:hover{ border-style:solid; color:var(--text); }

    .btn{
      appearance:none; border:none; cursor:pointer;
      font-weight:800; letter-spacing:.01em;
      padding:0.7rem 1rem; border-radius:11px;
      transition:.12s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:7px;
      box-shadow: var(--shadow-soft);
      background: var(--primary);
      color:#fff; font-size:0.9rem;
      white-space:nowrap;
    }
    .btn:hover{ filter:brightness(1.03); transform:translateY(-1px); }
    .btn svg{ width:15px;height:15px; }
    .btn-secondary{
      background:#111827; color:#fff;
    }
    .btn-ghost{
      background:#eef2f7; color:#111827; border:1px solid var(--border);
    }

    /* ===== Filters (segmented) ===== */
    .filters{
      display:flex; gap:6px; flex-wrap:wrap;
      background:var(--surface-muted);
      border:1px solid var(--border);
      padding:6px; border-radius:999px;
    }
    .filter-btn{
      border:none; cursor:pointer;
      font-size:12px; font-weight:800; letter-spacing:.02em;
      padding:7px 12px; border-radius:999px;
      color:#475569; background:transparent;
      transition:.1s ease;
      display:inline-flex; align-items:center; gap:6px;
    }
    .filter-btn.active{
      background:#0b1220; color:#fff; box-shadow: var(--shadow-soft);
    }
    .filter-dot{ width:7px;height:7px;border-radius:999px; display:inline-block; }
    .dot-safe{background:var(--success)}
    .dot-soon{background:var(--primary)}
    .dot-h3{background:var(--warning)}
    .dot-exp{background:var(--danger)}

    /* ===== Table ===== */
    table.subs-table{
      width:100%; border-collapse:separate; border-spacing:0 8px;
    }
    table.subs-table thead th{
      padding:0.8rem 0.9rem;
      background: #f8fafc;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      font-size:0.78rem; font-weight:900;
      text-transform:uppercase; letter-spacing:.08em;
      color:#111827;
    }
    table.subs-table thead th:first-child{
      border-left:1px solid var(--border); border-radius:12px 0 0 12px;
      width:64px;
    }
    table.subs-table thead th:last-child{
      border-right:1px solid var(--border); border-radius:0 12px 12px 0;
      width:220px;
    }

    table.subs-table tbody tr{
      background:var(--surface);
      border:1px solid var(--border);
      box-shadow: var(--shadow-soft);
      border-radius:12px; overflow:hidden;
      transition:.12s ease;
    }
    table.subs-table tbody tr:hover{
      transform:translateY(-1px); box-shadow: var(--shadow);
    }
    table.subs-table td{
      padding:0.95rem 0.9rem; vertical-align:middle; font-size:0.94rem;
      border:none !important; background:transparent !important;
    }
    td[data-label="Service"] strong{ font-size:0.98rem; font-weight:800; }
    td[data-label="Brand"] .brand-pill{
      display:inline-flex; padding:4px 8px; border-radius:999px;
      background:#f8fafc; border:1px solid var(--border);
      font-size:0.8rem; font-weight:900; color:#0b1220;
    }
    td[data-label="URL"] a{
      color:#1d4ed8; font-weight:800; text-decoration:none;
      border-bottom:1px dashed rgba(29,78,216,.35);
      word-break:break-all;
    }
    td[data-label="URL"] a:hover{ border-bottom-style:solid; }

    .days{
      font-weight:900; font-size:1.02rem;
      display:flex; align-items:center; gap:8px; white-space:nowrap;
    }
    .days .num{ font-size:1.2rem; }

    .status-pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 9px; border-radius:999px;
      font-size:11px; font-weight:900; letter-spacing:.06em;
      border:1px solid transparent; background:#fff;
      white-space:nowrap;
    }
    .st-expired{ color:#b91c1c; background:#fff1f2; border-color:#fecaca; }
    .st-h1{ color:#7c2d12; background:#fff7ed; border-color:#fed7aa; }
    .st-h2{ color:#92400e; background:#fffbeb; border-color:#fde68a; }
    .st-h3{ color:#b45309; background:#fffbeb; border-color:#fcd34d; }
    .st-soon{ color:#1d4ed8; background:#eff6ff; border-color:#bfdbfe; }
    .st-safe{ color:#065f46; background:#ecfdf5; border-color:#bbf7d0; }

    /* Action buttons */
    .actions{
      display:flex; justify-content:flex-end; gap:6px; flex-wrap:wrap;
    }
    .action-btn{
      padding:0.5rem 0.75rem; font-size:0.8rem; border-radius:10px;
      min-width:74px; box-shadow: var(--shadow-soft);
      display:inline-flex; align-items:center; gap:6px; font-weight:900;
      border:1px solid transparent; cursor:pointer;
    }
    .btn-edit{ background:#0b1220; color:#fff; }
    .btn-add30{ background:#16a34a; color:#fff; }
    .btn-add365{ background:#0ea5e9; color:#fff; }
    .btn-delete{ background:#ef4444; color:#fff; }
    .action-btn svg{ width:14px;height:14px; }
    .mini-note{
      font-size:11px; font-weight:800; color:var(--text-secondary);
      margin-top:4px; text-align:right;
    }

    /* Logs */
    .logs-wrap{
      max-height:340px; overflow:auto;
      border:1px solid var(--border); border-radius:12px;
      background:var(--surface-muted);
    }
    .logs{ width:100%; border-collapse:collapse; font-size:0.9rem; }
    .logs th,.logs td{
      padding:.6rem .8rem; text-align:left; border-bottom:1px solid var(--border);
      background:transparent;
    }
    .logs th{
      position:sticky; top:0; background:var(--surface);
      font-size:.75rem; text-transform:uppercase; letter-spacing:.06em;
      color:var(--text-secondary); font-weight:900;
    }
    .log-pill{
      display:inline-flex; padding:3px 8px; border-radius:999px; font-size:11px; font-weight:900;
      border:1px solid var(--border); background:white;
    }
    .pill-INFO{color:#2563eb;}
    .pill-WARN{color:#b45309;}
    .pill-ERROR{color:#b91c1c;}

    /* Trigger fixed */
    .trigger-fixed{
      position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
      width:92%; max-width:440px;
      background:#0b1220; color:white;
      padding:0.9rem 1.2rem; border-radius:999px;
      font-weight:900; letter-spacing:.02em;
      box-shadow: 0 14px 28px rgba(11,18,32,0.30);
      z-index:1000; text-decoration:none; text-align:center; font-size:0.98rem;
      display:flex; justify-content:center; align-items:center; gap:8px;
      transition:.12s ease;
    }
    .trigger-fixed svg{ width:16px;height:16px; }
    .trigger-fixed:hover{ filter:brightness(1.05); transform:translateX(-50%) translateY(-1px); }

    /* Footer */
    footer{ margin-top:1rem; }
    .footer-inner{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:1rem 1.1rem;
      display:flex; justify-content:space-between; align-items:center;
      flex-wrap:wrap; gap:10px; box-shadow: var(--shadow-soft);
      color:var(--text-secondary); font-size:0.9rem;
    }
    .footer-brand{ display:flex; align-items:center; gap:10px;}
    .footer-logo{
      width:34px;height:34px;border-radius:9px; display:grid; place-items:center;
      background:#0b1220;color:white;font-weight:900;font-size:.9rem;
    }
    .footer-title{ font-weight:900; color:#0b1220; }
    .footer-subtitle{ font-size:12px; font-weight:700; }

    @media (min-width: 768px){
      .form-grid{ grid-template-columns:repeat(4,1fr); }
      table.subs-table{ border-spacing:0 7px; }
      .trigger-fixed{ bottom:26px; right:26px; left:auto; transform:none; width:auto; }
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="top-left">
        <div class="logo">RDR</div>
        <div class="title-wrap">
          <h1>RDR Hosting Reminder</h1>
          <div class="subtitle">Corporate subscription expiry monitoring</div>
        </div>
      </div>

      <div class="top-right">
        <span class="chip">üë§ {{ username }}</span>
        <span class="chip">üïò {{ now.strftime('%d %B %Y - %H:%M WIB') }}</span>

        <!-- Actions dropdown -->
        <div class="menu" id="menu">
          <button class="menu-btn" type="button" id="menuBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <circle cx="12" cy="12" r="3"/><circle cx="19" cy="12" r="3"/><circle cx="5" cy="12" r="3"/>
            </svg>
            Actions
          </button>
          <div class="menu-list">
            <a class="menu-item" href="/trigger">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
              </svg>
              Send List to Telegram
            </a>
            <a class="menu-item" href="/telegram-test">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              Test Telegram
            </a>
            <a class="menu-item" href="/export">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export CSV
            </a>

            <div class="menu-sep"></div>

            <label class="menu-item" style="width:100%">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Import CSV
              <input id="importFile" type="file" accept=".csv" style="display:none">
            </label>
          </div>
        </div>

        <a class="logout" href="/logout">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          Logout
        </a>
      </div>
    </div>

    <header>
      <p class="subtle">Total: {{ subs|length }} active subscription{{ 's' if subs|length != 1 else '' }}</p>
      {% if health %}
        <p class="subtle" style="margin-top:6px;">
          Scheduler Health:
          <strong style="color:#0b1220">{{ health.daily or "-" }}</strong> /
          <strong style="color:#0b1220">{{ health.h3 or "-" }}</strong> /
          <strong style="color:#0b1220">{{ health.h2 or "-" }}</strong> /
          <strong style="color:#0b1220">{{ health.h1 or "-" }}</strong>
        </p>
      {% endif %}
    </header>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">Œ£</div>
        <div>
          <div class="stat-value">{{ subs|length }}</div>
          <div class="stat-label">Total Subscriptions</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üè∑Ô∏è</div>
        <div>
          <div class="stat-value">{{ grouped|length }}</div>
          <div class="stat-label">Brands</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚è≥</div>
        <div>
          <div class="stat-value">{{ expiring_soon }}</div>
          <div class="stat-label">Expiring Soon (‚â§7d)</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div>
          <div class="stat-value">{{ expired_count }}</div>
          <div class="stat-label">Expired</div>
        </div>
      </div>
    </div>

    <!-- ADD / EDIT FORM -->
    <div class="card">
      <div class="card-head">
        <h2 id="form-title">Add New Subscription</h2>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <span class="chip">Timezone: Asia/Jakarta</span>
          <span class="chip">Telegram Alerts: ON</span>
        </div>
      </div>

      <form id="subscription-form" method="post" action="/add">
        <div class="form-grid">
          <input type="text" id="name" name="name" placeholder="Service Name" required>
          <input type="url" id="url" name="url" placeholder="URL" required>
          <input type="text" id="brand" name="brand" placeholder="Brand Domain (contoh: RADAR138, K39, USR)" required>

          <input type="date" id="expires_at_picker" required>
          <input type="hidden" id="expires_at" name="expires_at" required>
        </div>

        <div class="quick-row">
          <button type="button" class="quick-btn" onclick="quickAddDays(7)">+7 days</button>
          <button type="button" class="quick-btn" onclick="quickAddDays(14)">+14 days</button>
          <button type="button" class="quick-btn" onclick="quickAddDays(30)">+30 days</button>
          <button type="button" class="quick-btn" onclick="quickAddDays(365)">+1 year</button>
        </div>

        <div style="display:flex;gap:.6rem;flex-wrap:wrap">
          <button type="submit" class="btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            Save
          </button>
          <button type="button" class="btn btn-ghost" onclick="resetForm()">
            <svg viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
            Cancel Edit
          </button>
        </div>
      </form>
    </div>

    <!-- ACTIVE SUBS -->
    <div class="card">
      <div class="card-head">
        <h2>Active Subscriptions</h2>

        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="search" type="text" placeholder="Search service / brand..." style="max-width:240px">
          <div class="filters" id="filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="safe"><span class="filter-dot dot-safe"></span>Safe</button>
            <button class="filter-btn" data-filter="soon"><span class="filter-dot dot-soon"></span>Soon ‚â§7</button>
            <button class="filter-btn" data-filter="h3"><span class="filter-dot dot-h3"></span>H-3</button>
            <button class="filter-btn" data-filter="h2">H-2</button>
            <button class="filter-btn" data-filter="h1">H-1 / Today</button>
            <button class="filter-btn" data-filter="expired"><span class="filter-dot dot-exp"></span>Expired</button>
          </div>
        </div>
      </div>

      {% if subs %}
        {% for brand, items in grouped.items() %}
          <div class="subtle" style="font-weight:900;margin:8px 0 6px;color:#0b1220">
            {{ brand or "No Brand" }}
          </div>

          <table class="subs-table">
            <thead>
              <tr>
                <th>No</th>
                <th>Service</th>
                <th>Brand</th>
                <th>URL</th>
                <th>Expire Date</th>
                <th>Days Left</th>
                <th>Action</th>
              </tr>
            </thead>

            <tbody>
              {% for sub in items %}
                {% set days = (sub.expires_at - today).days %}
                <tr class="row" data-days="{{ days }}" data-expires="{{ sub.expires_at.strftime('%Y-%m-%d') }}">
                  <td data-label="No">{{ loop.index }}</td>

                  <td data-label="Service">
                    <strong>{{ sub.name }}</strong>
                  </td>

                  <td data-label="Brand">
                    <span class="brand-pill">{{ sub.brand or "‚Äì" }}</span>
                  </td>

                  <td data-label="URL">
                    <a href="{{ sub.url }}" target="_blank">{{ sub.url }}</a>
                  </td>

                  <td data-label="Expire">
                    {{ sub.expires_at.strftime('%d %B %Y') }}
                  </td>

                  <td data-label="Days Left" class="days"
                      style="color:
                        {% if days <= 3 %}var(--danger)
                        {% elif days <= 7 %}var(--warning)
                        {% else %}var(--success)
                        {% endif %}">
                    <span class="num">{{ days }}</span>
                    <span>{{ 'day' if days == 1 else 'days' }}</span>

                    {% if days < 0 %}
                      <span class="status-pill st-expired">EXPIRED</span>
                    {% elif days == 0 %}
                      <span class="status-pill st-expired">DUE TODAY</span>
                    {% elif days == 1 %}
                      <span class="status-pill st-h1">H-1</span>
                    {% elif days == 2 %}
                      <span class="status-pill st-h2">H-2</span>
                    {% elif days == 3 %}
                      <span class="status-pill st-h3">H-3</span>
                    {% elif days <= 7 %}
                      <span class="status-pill st-soon">SOON</span>
                    {% else %}
                      <span class="status-pill st-safe">SAFE</span>
                    {% endif %}
                  </td>

                  <td data-label="Action">
                    <div class="actions">
                      <button class="action-btn btn-edit"
                        onclick='editSubscription({{ sub.id }}, "{{ sub.name|e }}", "{{ sub.url }}", "{{ sub.brand or ""|e }}", "{{ sub.expires_at.strftime("%m/%d/%Y") }}")'>
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                          <path d="M12 20h9"/>
                          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                        </svg>
                        Edit
                      </button>

                      <button class="action-btn btn-add30" type="button"
                        onclick="extendDays({{ sub.id }}, 30, '{{ sub.expires_at.strftime('%Y-%m-%d') }}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                          <path d="M12 5v14"/><path d="M5 12h14"/>
                        </svg>
                        +30d
                      </button>

                      <button class="action-btn btn-add365" type="button"
                        onclick="extendDays({{ sub.id }}, 365, '{{ sub.expires_at.strftime('%Y-%m-%d') }}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                          <path d="M12 5v14"/><path d="M5 12h14"/>
                        </svg>
                        +1y
                      </button>

                      <form method="post" action="/delete/{{ sub.id }}" style="display:inline">
                        <button type="submit" class="action-btn btn-delete"
                          onclick="return confirm('Delete this subscription?')">
                          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                            <path d="M10 11v6"/><path d="M14 11v6"/>
                            <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                          </svg>
                          Delete
                        </button>
                      </form>
                    </div>
                    <div class="mini-note">Update expire via +30d / +1y tanpa edit manual</div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endfor %}
      {% else %}
        <p style="text-align:center;color:var(--text-secondary);padding:3rem 0">
          No active subscriptions yet. Add your first one above.
        </p>
      {% endif %}
    </div>

    <!-- LOGS -->
    <div class="card">
      <div class="card-head">
        <h2>Logs Terbaru</h2>
        <span class="chip">Last 200 events</span>
      </div>

      {% if logs %}
        <div class="logs-wrap">
          <table class="logs">
            <thead>
              <tr>
                <th>Waktu</th>
                <th>Level</th>
                <th>Pesan</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
                <tr>
                  <td>{{ log.created_at.strftime('%d %b %Y %H:%M') }}</td>
                  <td><span class="log-pill pill-{{ log.level }}">{{ log.level }}</span></td>
                  <td>{{ log.message }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="subtle">Belum ada logs.</p>
      {% endif %}
    </div>

    <!-- Trigger -->
    <a href="/trigger" class="trigger-fixed">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <line x1="22" y1="2" x2="11" y2="13"/>
        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
      Send List to Telegram
    </a>

    <!-- FOOTER -->
    <footer>
      <div class="footer-inner">
        <div class="footer-brand">
          <div class="footer-logo">RDR</div>
          <div>
            <div class="footer-title">RDR Hosting Reminder</div>
            <div class="footer-subtitle">Enterprise-grade monitoring & reminder system</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:12px;font-weight:700">
          <span>Timezone: Asia/Jakarta</span>
          <span>‚Ä¢</span>
          <span>Telegram Alerts Active</span>
          <span>‚Ä¢</span>
          <span>Build: {{ now.strftime('%d %b %Y') }}</span>
        </div>
      </div>
    </footer>

  </div>

  <script>
    // ===== Date picker sync: ISO <-> MM/DD/YYYY for backend =====
    const picker = document.getElementById("expires_at_picker");
    const hidden = document.getElementById("expires_at");

    function toMMDDYYYY(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-");
      return `${m}/${d}/${y}`;
    }
    function toISO(mmddyyyy){
      if(!mmddyyyy) return "";
      const [m,d,y] = mmddyyyy.split("/");
      return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }

    picker.addEventListener("change", () => {
      hidden.value = toMMDDYYYY(picker.value);
    });

    function quickAddDays(n){
      const now = new Date();
      now.setDate(now.getDate() + n);
      const iso = now.toISOString().slice(0,10);
      picker.value = iso;
      hidden.value = toMMDDYYYY(iso);
    }

    function editSubscription(id, name, url, brand, expires_at){
      document.getElementById('form-title').innerText = 'Edit Subscription';
      document.getElementById('name').value = name;
      document.getElementById('url').value = url;
      document.getElementById('brand').value = brand;

      picker.value = toISO(expires_at);
      hidden.value = expires_at;

      document.getElementById('subscription-form').action = `/update/${id}`;
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function resetForm(){
      document.getElementById('form-title').innerText='Add New Subscription';
      document.getElementById('subscription-form').reset();
      picker.value = "";
      hidden.value = "";
      document.getElementById('subscription-form').action='/add';
    }

    // ===== Extend expire client-side (no timedelta in Jinja) =====
    function extendDays(id, addDays, currentIso){
      const d = new Date(currentIso);
      d.setDate(d.getDate() + addDays);
      const iso = d.toISOString().slice(0,10);
      const mmdd = toMMDDYYYY(iso);

      const f = document.createElement("form");
      f.method = "post";
      f.action = `/update/${id}`;
      f.style.display = "none";

      const hiddenExpires = document.createElement("input");
      hiddenExpires.type = "hidden";
      hiddenExpires.name = "expires_at";
      hiddenExpires.value = mmdd;

      const hiddenName = document.createElement("input");
      hiddenName.type = "hidden";
      hiddenName.name = "name";
      hiddenName.value = ""; // backend kamu biasanya ignore kalau tidak ada, tapi ini aman

      const hiddenUrl = document.createElement("input");
      hiddenUrl.type = "hidden";
      hiddenUrl.name = "url";
      hiddenUrl.value = "";

      const hiddenBrand = document.createElement("input");
      hiddenBrand.type = "hidden";
      hiddenBrand.name = "brand";
      hiddenBrand.value = "";

      f.appendChild(hiddenName);
      f.appendChild(hiddenUrl);
      f.appendChild(hiddenBrand);
      f.appendChild(hiddenExpires);

      document.body.appendChild(f);
      f.submit();
    }

    // ===== Search =====
    const search = document.getElementById("search");
    if(search){
      search.addEventListener("input", () => {
        const q = search.value.toLowerCase();
        document.querySelectorAll(".row").forEach(r => {
          r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
        });
      });
    }

    // ===== Filters by days =====
    const filters = document.getElementById("filters");
    if(filters){
      filters.addEventListener("click", (e) => {
        const btn = e.target.closest(".filter-btn");
        if(!btn) return;
        const f = btn.dataset.filter;

        filters.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        document.querySelectorAll(".row").forEach(r => {
          const days = parseInt(r.dataset.days, 10);
          let show = true;

          if(f === "expired") show = days < 0;
          else if(f === "h1") show = (days === 0 || days === 1);
          else if(f === "h2") show = days === 2;
          else if(f === "h3") show = days === 3;
          else if(f === "soon") show = days >= 4 && days <= 7;
          else if(f === "safe") show = days > 7;
          else show = true;

          r.style.display = show ? "" : "none";
        });
      });
    }

    // ===== Dropdown actions =====
    const menu = document.getElementById("menu");
    const menuBtn = document.getElementById("menuBtn");
    menuBtn.addEventListener("click", () => menu.classList.toggle("open"));
    document.addEventListener("click", (e) => {
      if(!menu.contains(e.target)) menu.classList.remove("open");
    });

    // Import file submit
    const importFile = document.getElementById("importFile");
    if(importFile){
      importFile.addEventListener("change", () => {
        if(!importFile.files || !importFile.files[0]) return;
        const f = document.createElement("form");
        f.method = "post";
        f.action = "/import";
        f.enctype = "multipart/form-data";
        f.style.display="none";
        f.appendChild(importFile);
        document.body.appendChild(f);
        f.submit();
      });
    }
  </script>
</body>
</html>
