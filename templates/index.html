<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RDR Hosting Reminder</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #eef1f6;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#6b7280;
      --line:#e6e9f0;
      --accent:#7c4dff;
      --accent-2:#6d28d9;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#f3f4f6;
      --chip-ink:#374151;
      --radius:18px;
      --radius-sm:12px;
      --shadow: 0 8px 30px rgba(15,23,42,.06);
      --shadow-soft: 0 2px 10px rgba(15,23,42,.05);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 700px at 0% -10%, #f7f4ff, transparent),
                  radial-gradient(900px 600px at 100% -15%, #e8f0ff, transparent),
                  var(--bg);
    }

    .container{
      width:min(1200px, 100%);
      margin:20px auto 80px;
      padding:0 14px;
    }

    /* Header */
    .topbar{
      background:var(--card);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:22px;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position:sticky;
      top:10px;
      z-index:20;
      backdrop-filter: blur(8px);
    }

    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:800;letter-spacing:.2px;
    }
    .brand .logo{
      width:38px;height:38px;border-radius:12px;
      display:grid;place-items:center;
      background:linear-gradient(145deg, #101828, #3b2cc4);
      color:white;font-weight:800;
      box-shadow: var(--shadow-soft);
    }
    .brand small{display:block;font-size:12px;color:var(--muted);font-weight:600}

    .meta{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      color:var(--muted);font-size:13px;font-weight:600;
    }
    .pill{
      background:#f8fafc;border:1px solid var(--line);
      padding:8px 10px;border-radius:999px;display:flex;gap:8px;align-items:center;
    }

    /* Dropdown actions */
    .actions{
      position:relative;
    }
    .actions button{
      border:1px solid var(--line);
      background:#0f172a;color:white;
      padding:9px 12px;border-radius:12px;
      font-weight:700;cursor:pointer;
      display:flex;align-items:center;gap:8px;
      box-shadow:var(--shadow-soft);
    }
    .actions-menu{
      position:absolute;right:0;top:46px;
      min-width:220px;background:white;border:1px solid var(--line);
      border-radius:14px;box-shadow:var(--shadow);
      padding:6px;display:none;
    }
    .actions-menu a, .actions-menu form button{
      width:100%;text-align:left;display:flex;align-items:center;gap:10px;
      padding:10px 10px;border-radius:10px;border:none;background:transparent;
      font-weight:600;color:var(--ink);cursor:pointer;text-decoration:none;
    }
    .actions-menu a:hover, .actions-menu form button:hover{background:#f3f4f6}
    .actions.open .actions-menu{display:block}

    /* Layout sections */
    .grid{
      display:grid;grid-template-columns: 380px 1fr;gap:14px;margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    .section-title{
      padding:14px 16px;border-bottom:1px dashed var(--line);
      display:flex;align-items:center;justify-content:space-between;
    }
    .section-title h3{margin:0;font-size:16px;font-weight:800}
    .section-title .count{font-size:12px;color:var(--muted);font-weight:700}

    /* Stats */
    .stats{
      display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:12px;
    }
    .stat{
      background:#f8fafc;border:1px solid var(--line);border-radius:14px;padding:12px;
      display:flex;align-items:center;justify-content:space-between;
    }
    .stat .k{font-size:12px;color:var(--muted);font-weight:700}
    .stat .v{font-size:20px;font-weight:800}
    .stat.good .v{color:var(--good)}
    .stat.warn .v{color:var(--warn)}
    .stat.bad .v{color:var(--bad)}

    /* Form */
    form{margin:0}
    .form-wrap{padding:12px 12px 14px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field label{
      font-size:12px;font-weight:800;color:#111827;letter-spacing:.2px;
      display:flex;align-items:center;gap:6px;
    }
    .input, .input-date{
      border:1px solid var(--line);background:white;border-radius:12px;padding:10px 12px;
      font-size:14px;font-weight:600;color:var(--ink);outline:none;
      transition:.15s ease;
    }
    .input:focus, .input-date:focus{border-color:#c7b8ff;box-shadow:0 0 0 3px rgba(124,77,255,.12)}
    .input::placeholder{color:#9ca3af;font-weight:500}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:460px){.row{grid-template-columns:1fr}}

    .quick{
      display:flex;gap:6px;flex-wrap:wrap;margin:4px 0 8px;
    }
    .chip{
      background:var(--chip);border:1px solid var(--line);
      padding:6px 9px;border-radius:999px;font-size:12px;font-weight:800;color:var(--chip-ink);
      cursor:pointer;user-select:none;
    }
    .chip:hover{background:#eceff3}

    .btn-row{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
    .btn{
      border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;font-size:14px;
    }
    .btn.primary{
      background:linear-gradient(145deg,var(--accent),var(--accent-2));color:white;
      box-shadow:0 8px 18px rgba(124,77,255,.28);
    }
    .btn.ghost{
      background:#f3f4f6;color:#111827;border:1px solid var(--line);
    }

    /* Filters */
    .filters{
      padding:10px 12px;display:flex;gap:6px;flex-wrap:wrap;border-bottom:1px solid var(--line);
    }
    .filter{
      padding:7px 11px;border-radius:999px;font-size:12px;font-weight:800;
      background:#f6f7fb;border:1px solid var(--line);color:#374151;
      cursor:pointer;transition:.12s ease;
    }
    .filter.active{
      background:#0f172a;color:white;border-color:#0f172a;
      box-shadow:0 6px 14px rgba(15,23,42,.18);
    }

    /* Brand blocks */
    .brand-block{margin-top:12px}
    .brand-head{
      padding:12px 14px;border-bottom:1px dashed var(--line);
      display:flex;align-items:center;justify-content:space-between;
    }
    .brand-name{
      display:flex;align-items:center;gap:8px;font-weight:900;font-size:15px;letter-spacing:.7px;
    }
    .brand-pill{
      background:#111827;color:white;padding:5px 9px;border-radius:999px;font-size:11px;font-weight:800;
    }

    /* Item row */
    .item{
      display:grid;
      grid-template-columns: 50px 1.3fr .9fr 1.2fr .8fr .7fr auto;
      gap:10px;
      padding:12px 14px;
      align-items:center;
      border-top:1px solid var(--line);
    }
    .item:first-child{border-top:none}
    @media (max-width: 1100px){
      .item{
        grid-template-columns: 50px 1fr;
        grid-auto-rows:auto;
        gap:6px;
      }
      .item > div[data-col]{grid-column:1/-1}
      .item .actions-col{grid-column:1/-1}
    }

    .num{
      width:34px;height:34px;border-radius:10px;
      display:grid;place-items:center;background:#f3f4f6;border:1px solid var(--line);
      font-weight:900;color:#111827;
    }

    .svc{
      font-weight:800;font-size:14px;line-height:1.35;
    }
    .svc .type{display:block;font-size:12px;color:var(--muted);font-weight:700}
    .url{
      color:#2563eb;text-decoration:none;font-weight:700;font-size:13px;
      word-break:break-all;
      display:inline-flex;align-items:center;gap:6px;
    }
    .url:hover{text-decoration:underline}

    .expire{
      font-weight:800;font-size:13px;
    }
    .expire .muted{font-size:12px;color:var(--muted);font-weight:700}

    .days{
      font-weight:900;font-size:15px;
      display:flex;align-items:center;gap:8px;
    }
    .days.good{color:var(--good)}
    .days.warn{color:var(--warn)}
    .days.bad{color:var(--bad)}

    .badge{
      font-size:11px;font-weight:900;letter-spacing:.5px;
      padding:5px 9px;border-radius:999px;border:1px solid transparent;
      display:inline-flex;align-items:center;gap:6px;
    }
    .badge.safe{color:#0f5132;background:#e9f9ef;border-color:#b8efcd}
    .badge.soon{color:#0b4cb8;background:#e8f0ff;border-color:#c2d6ff}
    .badge.h3{color:#7c2d12;background:#fff1e7;border-color:#ffd9c7}
    .badge.h2{color:#92400e;background:#fff7e6;border-color:#fde2a7}
    .badge.h1{color:#991b1b;background:#ffecec;border-color:#ffc8c8}
    .badge.expired{color:#991b1b;background:#ffecec;border-color:#ffc8c8}

    .actions-col{
      display:flex;gap:6px;justify-content:flex-end;flex-wrap:wrap;
    }
    .mini{
      font-size:12px;font-weight:900;border-radius:10px;padding:7px 9px;border:1px solid var(--line);
      background:white;cursor:pointer;display:inline-flex;align-items:center;gap:6px;
    }
    .mini:hover{background:#f5f6f9}
    .mini.green{background:#0f9d58;color:white;border-color:#0f9d58}
    .mini.blue{background:#2563eb;color:white;border-color:#2563eb}
    .mini.red{background:#ef4444;color:white;border-color:#ef4444}
    .mini.outline{background:white;color:#111827}
    .mini svg{width:14px;height:14px}

    /* Footer */
    footer{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(255,255,255,.9);
      border-top:1px solid var(--line);
      backdrop-filter: blur(8px);
    }
    .footer-in{
      width:min(1200px, 100%);
      margin:0 auto;padding:10px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-size:12px;color:var(--muted);font-weight:700;
    }
    .footer-in a{color:#111827;text-decoration:none;font-weight:800}
    .footer-in a:hover{text-decoration:underline}

    /* Small helper */
    .empty{
      padding:20px;color:var(--muted);font-weight:700;font-size:14px;text-align:center;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">RDR</div>
        <div>
          RDR Hosting Reminder
          <small>Dashboard & Telegram Notify</small>
        </div>
      </div>

      <div class="meta">
        <div class="pill">üïí {{ now.strftime('%d %B %Y - %H:%M') }} WIB</div>
        <div class="pill">üìå Total: {{ subs|length }} item</div>
      </div>

      <div class="actions" id="actions">
        <button type="button" onclick="toggleActions()">
          ‚öôÔ∏è Actions
          <span style="opacity:.7">‚ñæ</span>
        </button>
        <div class="actions-menu">
          <a href="/trigger">üöÄ Send to Telegram (Full List)</a>
          <a href="/docs">üìö API Docs</a>
          <a href="/openapi.json">üßæ OpenAPI JSON</a>
          <a href="/keep-alive">üíö Keep Alive</a>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: FORM + STATS -->
      <section class="card">
        <div class="section-title">
          <h3>Tambah / Edit Subscription</h3>
          <div class="count">Input cepat & rapi</div>
        </div>

        <div class="stats">
          <div class="stat warn">
            <div>
              <div class="k">Expiring ‚â§ 7 hari</div>
              <div class="v">{{ expiring_soon }}</div>
            </div>
            <div>‚ö†Ô∏è</div>
          </div>
          <div class="stat bad">
            <div>
              <div class="k">Expired</div>
              <div class="v">{{ expired_count }}</div>
            </div>
            <div>üíÄ</div>
          </div>
        </div>

        <div class="form-wrap">
          <!-- FORM ADD -->
          <form action="/add" method="post" id="subForm">
            <div class="field">
              <label>Service Name</label>
              <input class="input" name="name" placeholder="Contoh: VPS HumanCityMD" required>
            </div>

            <div class="field">
              <label>URL</label>
              <input class="input" name="url" placeholder="https://domain.com" required>
            </div>

            <div class="field">
              <label>Brand / Group</label>
              <input class="input" name="brand" placeholder="RADAR138 / UNSUR138 / dll">
            </div>

            <!-- DATE PICKER (UI) + HIDDEN (SUBMIT mm/dd/yyyy) -->
            <div class="field">
              <label>Expire Date</label>
              <div class="row">
                <input class="input-date" type="date" id="expireDatePicker" />
                <input class="input" type="text" name="expires_at" id="expireText"
                       placeholder="mm/dd/yyyy" required>
              </div>

              <div class="quick">
                <div class="chip" onclick="addDays(7)">+7 days</div>
                <div class="chip" onclick="addDays(14)">+14 days</div>
                <div class="chip" onclick="addDays(30)">+30 days</div>
                <div class="chip" onclick="addYears(1)">+1 year</div>
                <div class="chip" onclick="setToday()">Today</div>
                <div class="chip" onclick="clearDate()">Clear</div>
              </div>
            </div>

            <div class="btn-row">
              <button class="btn primary" type="submit">üíæ Save Subscription</button>
              <button class="btn ghost" type="reset" onclick="resetEdit()">‚Ü©Ô∏è Reset</button>
            </div>
          </form>
        </div>
      </section>

      <!-- RIGHT: LIST -->
      <section class="card">
        <div class="filters" id="filters">
          <div class="filter active" data-filter="all" onclick="applyFilter('all')">All</div>
          <div class="filter" data-filter="safe" onclick="applyFilter('safe')">Safe</div>
          <div class="filter" data-filter="soon" onclick="applyFilter('soon')">Soon ‚â§7</div>
          <div class="filter" data-filter="h3" onclick="applyFilter('h3')">H-3</div>
          <div class="filter" data-filter="h2" onclick="applyFilter('h2')">H-2</div>
          <div class="filter" data-filter="h1" onclick="applyFilter('h1')">H-1/Today</div>
          <div class="filter" data-filter="expired" onclick="applyFilter('expired')">Expired</div>
        </div>

        {% if grouped and grouped|length > 0 %}
          {% for brand, items in grouped.items() %}
            <div class="brand-block" data-brand="{{ brand }}">
              <div class="brand-head">
                <div class="brand-name">
                  <span class="brand-pill">{{ brand }}</span>
                  <span style="font-size:12px;color:var(--muted);font-weight:800">
                    {{ items|length }} item{{ "s" if items|length != 1 else "" }}
                  </span>
                </div>
              </div>

              {% for sub in items %}
                {% set days_left = (sub.expires_at - today).days %}
                {% if days_left < 0 %}
                  {% set status = "expired" %}
                {% elif days_left == 0 or days_left == 1 %}
                  {% set status = "h1" %}
                {% elif days_left == 2 %}
                  {% set status = "h2" %}
                {% elif days_left == 3 %}
                  {% set status = "h3" %}
                {% elif days_left <= 7 %}
                  {% set status = "soon" %}
                {% else %}
                  {% set status = "safe" %}
                {% endif %}

                <div class="item" data-status="{{ status }}">
                  <div class="num">{{ loop.index }}</div>

                  <div data-col>
                    <div class="svc">
                      <span class="type">{{ sub.name.split(' ')[0] if sub.name else 'Service' }}</span>
                      {{ sub.name }}
                    </div>
                  </div>

                  <div data-col style="font-weight:800;font-size:13px;">
                    {{ sub.brand or "Tanpa Brand" }}
                  </div>

                  <div data-col>
                    <a class="url" href="{{ sub.url }}" target="_blank" rel="noopener">
                      üîó {{ sub.url }}
                    </a>
                  </div>

                  <div data-col class="expire">
                    <div class="muted">Expire</div>
                    {{ sub.expires_at.strftime('%d %B %Y') }}
                  </div>

                  <div data-col>
                    {% if days_left < 0 %}
                      <div class="days bad">
                        {{ days_left }} days
                        <span class="badge expired">EXPIRED</span>
                      </div>
                      <div style="font-size:12px;font-weight:800;color:var(--bad)">
                        Sudah Expired {{ -days_left }} Hari üíÄ
                      </div>
                    {% elif days_left <= 7 %}
                      <div class="days warn">
                        {{ days_left }} days
                        {% if status=="h3" %}<span class="badge h3">H-3</span>{% endif %}
                        {% if status=="h2" %}<span class="badge h2">H-2</span>{% endif %}
                        {% if status=="h1" %}<span class="badge h1">H-1/TODAY</span>{% endif %}
                        {% if status=="soon" %}<span class="badge soon">SOON</span>{% endif %}
                      </div>
                    {% else %}
                      <div class="days good">
                        {{ days_left }} days
                        <span class="badge safe">SAFE</span>
                      </div>
                    {% endif %}
                  </div>

                  <!-- ACTIONS -->
                  <div class="actions-col actions-col-right actions-col" data-col>
                    <!-- Edit -->
                    <form action="/update/{{ sub.id }}" method="post" style="display:none" id="editForm-{{sub.id}}">
                      <!-- We submit via JS prompt style; but keeping backend compatible -->
                    </form>

                    <button class="mini outline" type="button"
                            onclick="openEdit('{{ sub.id }}','{{ sub.name|e }}','{{ sub.url|e }}','{{ sub.brand|default('',true)|e }}','{{ sub.expires_at.strftime('%m/%d/%Y') }}')">
                      ‚úèÔ∏è Edit
                    </button>

                    <form action="/update/{{ sub.id }}" method="post">
                      <input type="hidden" name="name" value="{{ sub.name }}">
                      <input type="hidden" name="url" value="{{ sub.url }}">
                      <input type="hidden" name="brand" value="{{ sub.brand or '' }}">
                      <input type="hidden" name="expires_at" value="{{ (sub.expires_at + timedelta(days=30)).strftime('%m/%d/%Y') }}">
                      <button class="mini green" type="submit">‚ûï 30d</button>
                    </form>

                    <form action="/update/{{ sub.id }}" method="post">
                      <input type="hidden" name="name" value="{{ sub.name }}">
                      <input type="hidden" name="url" value="{{ sub.url }}">
                      <input type="hidden" name="brand" value="{{ sub.brand or '' }}">
                      <input type="hidden" name="expires_at" value="{{ (sub.expires_at + timedelta(days=365)).strftime('%m/%d/%Y') }}">
                      <button class="mini green" type="submit">‚ûï 1y</button>
                    </form>

                    <form action="/delete/{{ sub.id }}" method="post"
                          onsubmit="return confirm('Yakin mau delete {{ sub.name }}?')">
                      <button class="mini red" type="submit">üóëÔ∏è Delete</button>
                    </form>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        {% else %}
          <div class="empty">Belum ada subscription. Tambahin dulu di kiri ‚úÖ</div>
        {% endif %}
      </section>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="footer-in">
      <div>
        ¬© {{ now.year }} RDR Hosting Reminder ‚Ä¢ Built for long-term reliability.
      </div>
      <div>
        Need help? <a href="https://t.me/" target="_blank">Telegram</a>
      </div>
    </div>
  </footer>

  <script>
    // Dropdown
    function toggleActions(){
      document.getElementById("actions").classList.toggle("open");
    }
    document.addEventListener("click", (e)=>{
      const a = document.getElementById("actions");
      if(!a.contains(e.target)) a.classList.remove("open");
    });

    // Filter items by status
    function applyFilter(key){
      const filters = document.querySelectorAll(".filter");
      filters.forEach(f => f.classList.toggle("active", f.dataset.filter === key));

      document.querySelectorAll(".item").forEach(it=>{
        const s = it.dataset.status;
        it.style.display = (key==="all" || s===key) ? "grid" : "none";
      });
    }

    // Date helpers (submit mm/dd/yyyy)
    const picker = document.getElementById("expireDatePicker");
    const text = document.getElementById("expireText");

    function toMMDDYYYY(d){
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const yy = d.getFullYear();
      return `${mm}/${dd}/${yy}`;
    }

    function setPickerFromText(){
      const v = text.value.trim();
      const m = v.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(!m) return;
      const [_, mm, dd, yy] = m;
      picker.value = `${yy}-${mm}-${dd}`;
    }

    function setTextFromPicker(){
      if(!picker.value) return;
      const d = new Date(picker.value+"T00:00:00");
      text.value = toMMDDYYYY(d);
    }

    picker.addEventListener("change", setTextFromPicker);
    text.addEventListener("blur", setPickerFromText);

    function addDays(n){
      const base = picker.value ? new Date(picker.value+"T00:00:00") : new Date();
      base.setDate(base.getDate()+n);
      picker.value = base.toISOString().slice(0,10);
      setTextFromPicker();
    }
    function addYears(n){
      const base = picker.value ? new Date(picker.value+"T00:00:00") : new Date();
      base.setFullYear(base.getFullYear()+n);
      picker.value = base.toISOString().slice(0,10);
      setTextFromPicker();
    }
    function setToday(){
      const d = new Date();
      picker.value = d.toISOString().slice(0,10);
      setTextFromPicker();
    }
    function clearDate(){
      picker.value = "";
      text.value = "";
    }

    function resetEdit(){
      clearDate();
    }

    // Simple edit flow: fill left form then scroll
    function openEdit(id,name,url,brand,expires){
      const form = document.getElementById("subForm");
      form.action = "/update/"+id;

      form.querySelector("input[name='name']").value = name;
      form.querySelector("input[name='url']").value = url;
      form.querySelector("input[name='brand']").value = brand || "";
      text.value = expires;
      setPickerFromText();

      window.scrollTo({top:0, behavior:"smooth"});
    }

    // Auto-init: try sync picker from existing text
    setPickerFromText();
  </script>
</body>
</html>
