<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RDR Hosting Reminder — Dashboard</title>

  <!-- Inter font (corporate default) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg: #f4f6f9;
      --panel: #ffffff;
      --panel-2:#f8fafc;
      --line:#e6ebf2;
      --text:#0f172a;
      --muted:#64748b;
      --brand:#0b5fff;
      --brand-2:#6a5cff;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:16px;
      --radius-sm:12px;
      --shadow:0 6px 18px rgba(15, 23, 42, .06);
      --shadow-sm:0 2px 6px rgba(15, 23, 42, .05);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}

    .container{
      width:min(1200px, 96vw);
      margin:20px auto 40px;
    }

    /* ===== Header ===== */
    .topbar{
      background:var(--panel);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:20px;
      padding:14px 16px;
      display:flex; align-items:center; gap:12px;
      position:sticky; top:12px; z-index:5;
    }
    .brandmark{
      display:flex; align-items:center; gap:10px; padding:6px 8px;
      border-radius:12px; background:var(--panel-2);
    }
    .brandmark .logo{
      width:36px; height:36px; border-radius:50%;
      display:grid; place-items:center; color:white;
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      font-weight:800; letter-spacing:.5px;
    }
    .brandmark .title{ font-weight:800; font-size:15px; line-height:1.1; }
    .brandmark .subtitle{ font-size:12px; color:var(--muted); }

    .topbar-spacer{flex:1}

    .userchip{
      display:flex; align-items:center; gap:10px;
      background:var(--panel-2);
      border:1px solid var(--line);
      padding:8px 10px; border-radius:999px;
      font-weight:600; font-size:13px;
    }
    .userchip i{color:var(--brand)}

    .actions{ position:relative; }
    .actions-btn{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:white;
      padding:8px 12px; border-radius:999px;
      font-weight:600; font-size:13px;
      cursor:pointer; box-shadow:var(--shadow-sm);
    }
    .actions-menu{
      position:absolute; right:0; top:44px;
      width:220px; background:white; border:1px solid var(--line);
      border-radius:14px; box-shadow:var(--shadow);
      padding:6px; display:none;
    }
    .actions-menu.show{display:block}
    .actions-menu a, .actions-menu form button{
      width:100%; text-align:left; border:0; background:transparent;
      padding:10px 10px; border-radius:10px; cursor:pointer;
      font-weight:600; font-size:13px; color:var(--text);
      display:flex; align-items:center; gap:8px;
    }
    .actions-menu a:hover,
    .actions-menu form button:hover{ background:var(--panel-2); }
    .actions-menu .danger{ color:var(--bad); }

    /* ===== KPI row ===== */
    .kpi-row{
      margin-top:14px;
      display:grid; grid-template-columns:repeat(4,1fr); gap:12px;
    }
    .kpi{
      background:var(--panel); border:1px solid var(--line);
      border-radius:16px; padding:12px 14px; box-shadow:var(--shadow-sm);
      display:flex; align-items:center; gap:12px;
    }
    .kpi .ico{
      width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
      background:var(--panel-2); color:var(--brand); font-size:18px;
    }
    .kpi .label{font-size:12px; color:var(--muted); font-weight:600}
    .kpi .value{font-size:20px; font-weight:800; margin-top:2px}

    /* ===== Control Bar ===== */
    .controlbar{
      margin-top:14px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      box-shadow:var(--shadow-sm);
    }
    .searchbox{
      flex:1; min-width:220px;
      display:flex; align-items:center; gap:8px;
      background:var(--panel-2);
      border:1px solid var(--line);
      padding:8px 10px; border-radius:12px;
    }
    .searchbox input{
      width:100%; border:0; outline:none; background:transparent;
      font-size:14px;
    }

    .filters{
      display:flex; align-items:center; gap:6px; flex-wrap:wrap;
      background:var(--panel-2);
      border:1px solid var(--line);
      padding:6px; border-radius:999px;
    }
    .filter-pill{
      border:0; background:transparent; cursor:pointer;
      padding:7px 11px; border-radius:999px;
      font-size:13px; font-weight:700; color:#334155;
      display:flex; align-items:center; gap:7px;
    }
    .filter-pill .dot{
      width:8px; height:8px; border-radius:50%;
      background:#cbd5e1;
    }
    .filter-pill.active{
      background:#0f172a; color:white;
    }
    .filter-pill.active .dot{background:white}

    /* ===== Add/Edit form ===== */
    .panel{
      margin-top:14px; background:var(--panel); border:1px solid var(--line);
      border-radius:18px; padding:14px; box-shadow:var(--shadow);
    }
    .panel h3{margin:0 0 10px; font-size:16px; font-weight:800}

    .form-grid{
      display:grid; grid-template-columns:1.2fr 1.6fr .9fr .8fr auto;
      gap:8px; align-items:center;
    }
    .form-grid input{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:white; outline:none;
      font-size:14px;
    }
    .form-grid input:focus{
      border-color:var(--brand); box-shadow:0 0 0 3px rgba(11,95,255,.12);
    }

    .quick-btns{
      grid-column:1 / -1;
      display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;
    }
    .chip{
      border:1px solid var(--line); background:var(--panel-2);
      padding:6px 10px; border-radius:999px;
      font-weight:700; font-size:12px; cursor:pointer;
    }

    .btn{
      border:0; cursor:pointer; font-weight:800; font-size:13px;
      padding:10px 12px; border-radius:12px; display:inline-flex; align-items:center; gap:8px;
      box-shadow:var(--shadow-sm);
    }
    .btn-primary{background:var(--brand); color:white;}
    .btn-ghost{background:white; border:1px solid var(--line); color:var(--text);}

    /* ===== Brand section ===== */
    .brand-section{margin-top:14px;}
    .brand-head{
      display:flex; align-items:center; justify-content:space-between;
      margin:8px 2px;
    }
    .brand-title{
      font-weight:900; letter-spacing:.4px;
      font-size:15px;
    }
    .brand-count{color:var(--muted); font-size:12px; font-weight:700}

    .list{
      background:var(--panel); border:1px solid var(--line);
      border-radius:16px; overflow:hidden;
    }
    .list-row{
      display:grid;
      grid-template-columns:60px 2fr 1.1fr 2.1fr 1.2fr 1.2fr 190px;
      gap:10px; align-items:center;
      padding:12px 14px; border-top:1px solid var(--line);
    }
    .list-row:first-child{border-top:0}
    .num{
      width:36px; height:36px; border-radius:10px; background:var(--panel-2);
      display:grid; place-items:center; font-weight:900;
    }
    .svc-name{font-weight:800}
    .svc-url{font-size:12px; color:var(--muted); margin-top:3px; word-break:break-all}
    .brand-badge{
      display:inline-flex; align-items:center; gap:6px;
      background:var(--panel-2); border:1px solid var(--line);
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800;
      width:max-content;
    }

    .expire{ font-weight:700; }
    .days{
      display:flex; align-items:center; gap:8px; font-weight:800;
    }
    .days .n{ font-size:18px; }

    .status{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 9px; font-size:11px; font-weight:900;
      border-radius:999px; letter-spacing:.3px; border:1px solid transparent;
      text-transform:uppercase;
    }
    .st-safe{ color:var(--good); background:#ecfdf3; border-color:#b7f0cc;}
    .st-soon{ color:#2563eb; background:#eff6ff; border-color:#b9d5ff;}
    .st-h3{ color:#7c3aed; background:#f5f3ff; border-color:#ddd6fe;}
    .st-h2{ color:var(--warn); background:#fffbeb; border-color:#fde68a;}
    .st-h1{ color:#fb923c; background:#fff7ed; border-color:#fed7aa;}
    .st-exp{ color:var(--bad); background:#fef2f2; border-color:#fecaca;}

    .actions-col{
      display:flex; justify-content:flex-end;
    }
    .btn-stack{
      display:grid; grid-template-columns:1fr 1fr; gap:6px; width:180px;
    }
    .btn-sm{
      padding:8px 10px; font-size:12px; border-radius:10px; font-weight:900;
      display:flex; align-items:center; justify-content:center; gap:6px;
      border:1px solid var(--line); background:white; cursor:pointer;
    }
    .btn-sm.edit{background:#0f172a; color:white; border-color:#0f172a;}
    .btn-sm.plus30{background:#16a34a; color:white; border-color:#16a34a;}
    .btn-sm.plus1y{background:#0ea5e9; color:white; border-color:#0ea5e9;}
    .btn-sm.delete{background:#ef4444; color:white; border-color:#ef4444; grid-column:1 / -1;}

    /* ===== Logs ===== */
    /* === Logs scroll container (lebih pendek + scrollbar keliatan) === */
.logs-scroll{
  max-height: 220px;          /* lebih pendek, coba 200–260px sesuai selera */
  overflow-y: scroll;         /* paksa scrollbar selalu muncul */
  border-radius: 14px;
  border: 1px solid var(--line);
}

/* header table tetap nempel pas scroll */
.logs-scroll thead th{
  position: sticky;
  top: 0;
  z-index: 1;
  background: var(--panel-2);
}

/* bikin scrollbar lebih subtle (opsional, aman di Chrome/Edge) */
.logs-scroll::-webkit-scrollbar{
  width: 8px;
}
.logs-scroll::-webkit-scrollbar-thumb{
  background: #cbd5e1;
  border-radius: 999px;
}
.logs-scroll::-webkit-scrollbar-track{
  background: transparent;
}

    .logs-head{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;
    }
    .logs-table{
      width:100%; border-collapse:separate; border-spacing:0;
      overflow:hidden; border-radius:14px; border:1px solid var(--line);
    }
    .logs-table th, .logs-table td{
      padding:10px 12px; font-size:13px; border-bottom:1px solid var(--line);
      text-align:left; vertical-align:top;
    }
    .logs-table th{
      background:var(--panel-2); font-size:12px; letter-spacing:.4px; text-transform:uppercase;
      color:#334155;
    }
    .level{
      font-weight:900; font-size:11px; padding:4px 8px; border-radius:999px; display:inline-block;
      background:var(--panel-2); border:1px solid var(--line);
    }
    .lvl-info{color:#0ea5e9}
    .lvl-warn{color:#f59e0b}
    .lvl-error{color:#ef4444}
    
    footer{
      margin-top:20px; color:var(--muted); font-size:12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      padding:12px 4px;
    }

    @media (max-width: 980px){
      .form-grid{grid-template-columns:1fr 1fr; }
      .list-row{
        grid-template-columns:50px 1fr;
        grid-auto-rows:auto;
      }
      .actions-col{justify-content:flex-start;}
      .btn-stack{width:100%;}
    }
  </style>
</head>
<body>

<div class="container">

  <!-- ===== TOP BAR ===== -->
  <header class="topbar">
    <div class="brandmark">
      <div class="logo">RDR</div>
      <div>
        <div class="title">RDR Hosting Reminder</div>
        <div class="subtitle">Hosting Subscription Watchlist</div>
      </div>
    </div>

    <div class="topbar-spacer"></div>

    <div class="userchip">
      <i class="fa-solid fa-user-shield"></i>
      <span>{{ username or "admin" }}</span>
    </div>

    <div class="actions">
      <button class="actions-btn" id="actionsToggle" type="button">
        <i class="fa-solid fa-ellipsis-vertical"></i>
        Actions
        <i class="fa-solid fa-caret-down"></i>
      </button>
      <div class="actions-menu" id="actionsMenu">
        <a href="/trigger"><i class="fa-solid fa-paper-plane"></i> Send Full List</a>
        <a href="/telegram-test"><i class="fa-brands fa-telegram"></i> Test Telegram</a>
        <a href="/export-csv"><i class="fa-solid fa-file-export"></i> Export CSV</a>
        <form action="/import-csv" method="post" enctype="multipart/form-data">
          <label style="display:block;padding:0 6px 6px;color:var(--muted);font-size:11px;font-weight:800;">Import CSV</label>
          <input type="file" name="file" accept=".csv" style="width:100%;padding:8px;border:1px dashed var(--line);border-radius:10px;background:var(--panel-2);margin-bottom:6px;">
          <button type="submit"><i class="fa-solid fa-file-import"></i> Upload & Import</button>
        </form>
        <a href="/logout" class="danger"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
      </div>
    </div>
  </header>

  <!-- ===== KPI ===== -->
  <section class="kpi-row">
    <div class="kpi">
      <div class="ico"><i class="fa-solid fa-layer-group"></i></div>
      <div>
        <div class="label">Total Subscription</div>
        <div class="value">{{ subs|length }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="ico"><i class="fa-solid fa-triangle-exclamation"></i></div>
      <div>
        <div class="label">Expiring Soon (≤7d)</div>
        <div class="value">{{ expiring_soon or 0 }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="ico"><i class="fa-solid fa-skull-crossbones"></i></div>
      <div>
        <div class="label">Expired</div>
        <div class="value">{{ expired_count or 0 }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="ico"><i class="fa-solid fa-clock"></i></div>
      <div>
        <div class="label">Now (WIB)</div>
        <div class="value" style="font-size:14px;font-weight:800;">
          {{ now.strftime('%d %b %Y · %H:%M') if now else "" }}
        </div>
      </div>
    </div>
  </section>

  <!-- ===== CONTROL BAR ===== -->
  <section class="controlbar">
    <div class="searchbox">
      <i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i>
      <input id="searchInput" type="text" placeholder="Search service / brand / url..." />
    </div>

    <div class="filters" id="filterBar">
      <button class="filter-pill active" data-filter="all" type="button">
        <span class="dot"></span> All
      </button>
      <button class="filter-pill" data-filter="safe" type="button">
        <span class="dot" style="background:var(--good)"></span> Safe
      </button>
      <button class="filter-pill" data-filter="soon" type="button">
        <span class="dot" style="background:#2563eb"></span> Soon ≤7
      </button>
      <button class="filter-pill" data-filter="h3" type="button">
        <span class="dot" style="background:#7c3aed"></span> H-3
      </button>
      <button class="filter-pill" data-filter="h2" type="button">
        <span class="dot" style="background:var(--warn)"></span> H-2
      </button>
      <button class="filter-pill" data-filter="h1" type="button">
        <span class="dot" style="background:#fb923c"></span> H-1 / Today
      </button>
      <button class="filter-pill" data-filter="expired" type="button">
        <span class="dot" style="background:var(--bad)"></span> Expired
      </button>
    </div>
  </section>

  <!-- ===== ADD / EDIT SUB ===== -->
  <section class="panel">
    <h3 id="formTitle">Add New Subscription</h3>

    <form id="subscriptionForm" action="/add" method="post">
      <div class="form-grid">
        <input id="nameInput" name="name" placeholder="Service name" required minlength="3"/>
        <input id="urlInput" name="url" placeholder="https://example.com" required/>
        <input id="brandInput" name="brand" placeholder="Brand / Domain (optional)"/>

        <!-- UI picker (yyyy-mm-dd) -->
        <input id="expiresInputUI" type="date" required/>
        <!-- hidden real payload (mm/dd/yyyy) -->
        <input id="expiresInput" name="expires_at" type="hidden" required/>

        <button class="btn btn-primary" type="submit">
          <i class="fa-solid fa-plus"></i> Save
        </button>

        <div class="quick-btns">
          <button type="button" class="chip" data-add-days="7">+7 days</button>
          <button type="button" class="chip" data-add-days="14">+14 days</button>
          <button type="button" class="chip" data-add-days="30">+30 days</button>
          <button type="button" class="chip" data-add-years="1">+1 year</button>
          <button type="button" class="chip" id="resetBtn" style="margin-left:auto;background:white;">
            Reset Form
          </button>
        </div>
      </div>
    </form>
  </section>

  <!-- ===== LIST ===== -->
  <section class="brand-section">
    {% set grouped_safe = grouped|default({}) %}
    {% if grouped_safe %}
      {% for brand, items in grouped_safe.items() %}
        <div class="brand-head">
          <div class="brand-title">{{ brand }}</div>
          <div class="brand-count">{{ items|length }} items</div>
        </div>

        <div class="list">
          {% for sub in items %}
            {% set days_left = (sub.expires_at - today).days %}
            {% set st = "safe" %}
            {% if days_left < 0 %}{% set st="expired" %}
            {% elif days_left <= 1 %}{% set st="h1" %}
            {% elif days_left == 2 %}{% set st="h2" %}
            {% elif days_left == 3 %}{% set st="h3" %}
            {% elif days_left <= 7 %}{% set st="soon" %}
            {% endif %}

            <div class="list-row item"
                 data-filter="{{ st }}"
                 data-search="{{ (sub.name ~ ' ' ~ (sub.brand or '') ~ ' ' ~ sub.url)|lower }}"
                 data-expires="{{ sub.expires_at.strftime('%Y-%m-%d') }}"
                 data-expires-mmdd="{{ sub.expires_at.strftime('%m/%d/%Y') }}"
                 data-id="{{ sub.id }}"
                 data-name="{{ sub.name|e }}"
                 data-url="{{ sub.url }}"
                 data-brand="{{ sub.brand or ''|e }}">

              <div class="num">{{ loop.index }}</div>

              <div>
                <div class="svc-name">{{ sub.name }}</div>
                <div class="svc-url"><i class="fa-solid fa-link"></i> <a href="{{ sub.url }}" target="_blank">{{ sub.url }}</a></div>
              </div>

              <div>
                <span class="brand-badge">{{ sub.brand or "Tanpa Brand" }}</span>
              </div>

              <div class="expire">
                {{ sub.expires_at.strftime('%d %B %Y') }}
              </div>

              <div class="days">
                <span class="n"
                  style="color:{% if days_left<0 %}var(--bad){% elif days_left<=7 %}var(--warn){% else %}var(--good){% endif %}">
                  {{ days_left }}
                </span>
                <span style="color:var(--muted);font-size:12px;font-weight:700;">days</span>
              </div>

              <div>
                {% if st=="safe" %}
                  <span class="status st-safe">SAFE</span>
                {% elif st=="soon" %}
                  <span class="status st-soon">SOON</span>
                {% elif st=="h3" %}
                  <span class="status st-h3">H-3</span>
                {% elif st=="h2" %}
                  <span class="status st-h2">H-2</span>
                {% elif st=="h1" %}
                  <span class="status st-h1">H-1 / TODAY</span>
                {% else %}
                  <span class="status st-exp">EXPIRED</span>
                {% endif %}
              </div>

              <div class="actions-col">
                <div class="btn-stack">

                  <!-- EDIT inline (no /edit/{id}) -->
                  <button class="btn-sm edit btn-edit-inline" type="button">
                    <i class="fa-solid fa-pen"></i> Edit
                  </button>

                  <!-- QUICK EXTEND -> POST /update/{id} -->
                  <form class="extend-form" action="/update/{{ sub.id }}" method="post" data-days="30">
                    <input type="hidden" name="name" value="{{ sub.name|e }}">
                    <input type="hidden" name="url" value="{{ sub.url }}">
                    <input type="hidden" name="brand" value="{{ sub.brand or ''|e }}">
                    <input type="hidden" name="expires_at" value="">
                    <button class="btn-sm plus30" type="submit"><i class="fa-solid fa-plus"></i> +30d</button>
                  </form>

                  <form class="extend-form" action="/update/{{ sub.id }}" method="post" data-years="1">
                    <input type="hidden" name="name" value="{{ sub.name|e }}">
                    <input type="hidden" name="url" value="{{ sub.url }}">
                    <input type="hidden" name="brand" value="{{ sub.brand or ''|e }}">
                    <input type="hidden" name="expires_at" value="">
                    <button class="btn-sm plus1y" type="submit"><i class="fa-solid fa-plus"></i> +1y</button>
                  </form>

                  <!-- DELETE tetap -->
                  <form action="/delete/{{ sub.id }}" method="post"
                        onsubmit="return confirm('Delete {{ sub.name }} ?')">
                    <button class="btn-sm delete" type="submit">
                      <i class="fa-solid fa-trash"></i> Delete
                    </button>
                  </form>
                </div>
              </div>

            </div>
          {% endfor %}
        </div>
      {% endfor %}
    {% else %}
      <div class="panel" style="text-align:center;color:var(--muted);font-weight:700;">
        Belum ada subscription.
      </div>
    {% endif %}
  </section>

  <!-- ===== LOGS ===== -->
  <section class="panel" style="margin-top:16px">
  <div class="logs-head">
    <h3 style="margin:0">Logs Terbaru</h3>
    <div style="font-size:12px;color:var(--muted);font-weight:800;">Last 200 events</div>
  </div>

  {% set logs_safe = logs|default([]) %}
  {% if logs_safe and logs_safe|length > 0 %}
    
    <!-- WRAPPER SCROLL -->
    <div class="logs-scroll">
      <table class="logs-table">
        <thead>
          <tr>
            <th style="width:180px">Waktu</th>
            <th style="width:90px">Level</th>
            <th>Pesan</th>
          </tr>
        </thead>
        <tbody>
          {% for lg in logs_safe %}
            {% set lvl = (lg.level or "INFO")|upper %}
            <tr>
              <td>{{ lg.created_at.strftime('%d %b %Y %H:%M') if lg.created_at else "-" }}</td>
              <td>
                <span class="level {% if lvl=='ERROR' %}lvl-error{% elif lvl=='WARN' %}lvl-warn{% else %}lvl-info{% endif %}">
                  {{ lvl }}
                </span>
              </td>
              <td>{{ lg.message }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  {% else %}
    <div style="padding:12px;border:1px dashed var(--line);border-radius:12px;color:var(--muted);font-weight:700;">
      Belum ada log.
    </div>
  {% endif %}
</section>


  <footer>
    <div>© {{ now.year if now else "2025" }} K39 - All Rights Reserved</div>
    <div style="font-weight:700;">System timezone: WIB (Asia/Jakarta)</div>
  </footer>

</div>

<script>
  // ===== Actions dropdown =====
  const toggle = document.getElementById("actionsToggle");
  const menu = document.getElementById("actionsMenu");
  toggle?.addEventListener("click", () => menu.classList.toggle("show"));
  document.addEventListener("click", (e) => {
    if (!menu.contains(e.target) && !toggle.contains(e.target)) menu.classList.remove("show");
  });

  // ===== Helpers date =====
  function toMMDDYYYY(d){
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const yy = d.getFullYear();
    return `${mm}/${dd}/${yy}`;
  }
  function toYYYYMMDD(d){
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const yy = d.getFullYear();
    return `${yy}-${mm}-${dd}`;
  }
  function fromMMDDYYYY(mmdd){
    // mm/dd/yyyy -> yyyy-mm-dd
    const [m,d,y] = mmdd.split("/");
    return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
  }

  // ===== Form binding (Add/Edit) =====
  const subscriptionForm = document.getElementById("subscriptionForm");
  const formTitle = document.getElementById("formTitle");
  const nameInput = document.getElementById("nameInput");
  const urlInput = document.getElementById("urlInput");
  const brandInput = document.getElementById("brandInput");
  const expiresUI = document.getElementById("expiresInputUI");
  const expiresHidden = document.getElementById("expiresInput");

  function syncExpiresHidden(){
    if (!expiresUI.value) {
      expiresHidden.value = "";
      return;
    }
    const d = new Date(expiresUI.value + "T00:00:00");
    expiresHidden.value = toMMDDYYYY(d);
  }
  expiresUI.addEventListener("change", syncExpiresHidden);

  // Ensure hidden value ready before submit
  subscriptionForm.addEventListener("submit", (e)=>{
    syncExpiresHidden();
    if (!expiresHidden.value) {
      e.preventDefault();
      alert("Tanggal expire wajib diisi.");
    }
  });

  // Reset form to "Add"
  const resetBtn = document.getElementById("resetBtn");
  resetBtn.addEventListener("click", ()=>{
    subscriptionForm.action = "/add";
    formTitle.textContent = "Add New Subscription";
    subscriptionForm.reset();
    expiresHidden.value = "";
  });

  // Quick add date buttons
  document.querySelectorAll(".chip[data-add-days], .chip[data-add-years]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const now = new Date();
      const addDays = btn.dataset.addDays ? parseInt(btn.dataset.addDays) : 0;
      const addYears = btn.dataset.addYears ? parseInt(btn.dataset.addYears) : 0;

      if (addDays) now.setDate(now.getDate() + addDays);
      if (addYears) now.setFullYear(now.getFullYear() + addYears);

      expiresUI.value = toYYYYMMDD(now);
      syncExpiresHidden();
    });
  });

  // ===== Inline edit handler =====
  document.querySelectorAll(".item .btn-edit-inline").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const row = btn.closest(".item");
      const id = row.dataset.id;
      nameInput.value = row.dataset.name || "";
      urlInput.value = row.dataset.url || "";
      brandInput.value = row.dataset.brand || "";
      expiresUI.value = row.dataset.expires; // yyyy-mm-dd
      syncExpiresHidden();

      subscriptionForm.action = `/update/${id}`;
      formTitle.textContent = `Edit Subscription #${id}`;
      window.scrollTo({top:0, behavior:"smooth"});
    });
  });

  // ===== Search + filter =====
  const searchInput = document.getElementById("searchInput");
  const items = Array.from(document.querySelectorAll(".item"));
  let activeFilter = "all";

  function applyFilters(){
    const q = (searchInput.value || "").trim().toLowerCase();
    items.forEach(it=>{
      const byFilter = (activeFilter==="all") || (it.dataset.filter===activeFilter);
      const bySearch = !q || (it.dataset.search || "").includes(q);
      it.style.display = (byFilter && bySearch) ? "grid" : "none";
    })
  }
  searchInput?.addEventListener("input", applyFilters);

  document.querySelectorAll(".filter-pill").forEach(p=>{
    p.addEventListener("click", ()=>{
      document.querySelectorAll(".filter-pill").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
      activeFilter = p.dataset.filter;
      applyFilters();
    })
  });

  // ===== Extend (+30d / +1y) via /update/{id} =====
  function addDays(dateStr, n){
    const d = new Date(dateStr+"T00:00:00");
    d.setDate(d.getDate()+n);
    return d;
  }
  function addYears(dateStr, n){
    const d = new Date(dateStr+"T00:00:00");
    d.setFullYear(d.getFullYear()+n);
    return d;
  }

  document.querySelectorAll(".extend-form").forEach(form=>{
    form.addEventListener("submit", (e)=>{
      const row = form.closest(".item");
      const expiresISO = row.dataset.expires; // yyyy-mm-dd
      let d;

      if (form.dataset.days){
        d = addDays(expiresISO, parseInt(form.dataset.days));
      } else if (form.dataset.years){
        d = addYears(expiresISO, parseInt(form.dataset.years));
      } else {
        return;
      }

      // backend wajib mm/dd/yyyy
      form.querySelector("input[name='expires_at']").value = toMMDDYYYY(d);
    });
  });
</script>

</body>
</html>
