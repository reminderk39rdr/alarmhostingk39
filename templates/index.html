<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RDR Hosting Reminder</title>

  <style>
    :root{
      --bg:#EEF0F3;
      --card:#FFFFFF;
      --ink:#121417;
      --muted:#6B7280;
      --muted-2:#9AA3AF;
      --primary:#7C5CFA;
      --primary-2:#9B7BFF;
      --success:#10B981;
      --warn:#F59E0B;
      --danger:#EF4444;
      --line:#E7E9EE;
      --chip:#F4F5F8;
      --chip-active:#0F172A;
      --radius:18px;
      --radius-sm:12px;
      --shadow:0 8px 24px rgba(16,24,40,.06);
      --shadow-soft:0 2px 10px rgba(16,24,40,.04);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:var(--bg);
    }

    a{color:#5B6CFF; text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{
      max-width:1200px;
      margin:22px auto 32px;
      padding:0 14px;
    }

    /* Topbar */
    .topbar{
      background:var(--card);
      box-shadow:var(--shadow);
      border-radius:20px;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:linear-gradient(145deg,#111827,#374151);
      display:grid;place-items:center;color:#fff;font-weight:800;letter-spacing:.5px;
      box-shadow:var(--shadow-soft);
    }
    .brand h1{
      font-size:16.5px; margin:0; font-weight:800;
    }
    .brand .sub{
      font-size:12px; color:var(--muted);
    }

    .stats{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .stat{
      background:var(--chip);
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:12.5px;
      display:flex; align-items:center; gap:6px;
      color:#111827;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.success{background:var(--success)}
    .dot.warn{background:var(--warn)}
    .dot.danger{background:var(--danger)}

    .right-actions{
      display:flex; align-items:center; gap:8px;
    }
    .btn{
      height:36px; padding:0 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff; color:#111827;
      font-size:13px; font-weight:700;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
      box-shadow:var(--shadow-soft);
      transition:.15s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{
      background:var(--primary); color:#fff; border-color:transparent;
      box-shadow:0 8px 18px rgba(124,92,250,.25);
    }
    .btn.ghost{background:#fff}
    .btn.small{height:30px; padding:0 9px; font-size:12px; border-radius:10px}
    .btn.danger{color:#fff; background:var(--danger); border-color:transparent}
    .btn.success{color:#fff; background:var(--success); border-color:transparent}

    .icon{
      width:14px;height:14px;display:inline-block;
    }

    /* Layout grid */
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid #F6F7FA;
    }
    .card-head{
      padding:14px 14px 8px;
      display:flex; align-items:center; justify-content:space-between;
      gap:8px;
    }
    .card-title{
      font-size:14.5px; font-weight:800; margin:0;
    }
    .card-sub{font-size:12px;color:var(--muted)}

    /* Form card */
    .form-body{padding:12px 14px 14px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .label{font-size:12px;color:var(--muted);font-weight:700}
    input{
      width:100%;
      height:42px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:14px;
      outline:none;
      transition:.1s ease;
    }
    input:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(124,92,250,.12)}
    .row{display:grid;grid-template-columns:1fr 1fr; gap:8px}
    @media (max-width:980px){
      .row{grid-template-columns:1fr}
    }

    .quick{
      display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;
    }
    .chip{
      background:var(--chip);
      border:1px solid var(--line);
      border-radius:999px;
      padding:5px 9px;
      font-size:12px; font-weight:800; color:#111827;
      cursor:pointer; user-select:none;
      transition:.12s ease;
    }
    .chip:hover{transform:translateY(-1px)}
    .form-actions{
      display:flex; gap:8px; margin-top:10px;
    }

    /* List / filters */
    .filters{
      padding:0 14px 10px;
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .filter{
      background:var(--chip);
      border:1px solid var(--line);
      color:#3B4452;
      font-weight:800;
      padding:7px 12px;
      border-radius:999px;
      font-size:12.5px;
      cursor:pointer;
      transition:.12s ease;
    }
    .filter.active{
      background:var(--chip-active);
      color:#fff; border-color:transparent;
    }

    .list-body{padding:0 10px 10px}

    .brand-block{
      margin:8px 0 12px;
      border-radius:14px;
      background:#FAFBFD;
      border:1px solid var(--line);
      overflow:hidden;
    }
    .brand-head{
      padding:10px 12px;
      background:#fff;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px dashed var(--line);
    }
    .brand-name{
      font-size:13.5px; font-weight:900; letter-spacing:.3px;
    }
    .brand-count{
      font-size:12px;color:var(--muted);font-weight:800;
    }

    .item{
      display:grid;
      grid-template-columns: 38px 1.3fr 1fr 130px 130px 170px;
      gap:8px;
      padding:10px 12px;
      align-items:center;
      background:#fff;
      border-top:1px solid var(--line);
    }
    .item:first-child{border-top:none}
    @media (max-width:1100px){
      .item{
        grid-template-columns: 34px 1.5fr 1fr;
        grid-auto-rows:auto;
        row-gap:6px;
      }
      .item .col-exp,
      .item .col-days,
      .item .col-actions{grid-column:2 / -1}
    }

    .no{
      font-weight:900; font-size:13px; color:#111827;
      width:32px;height:32px;border-radius:10px;
      display:grid;place-items:center;background:#F3F4F6;
    }

    .svc{
      font-weight:900; font-size:14px;
      display:flex; flex-direction:column; gap:2px;
    }
    .svc .name{line-height:1.3}
    .svc .url{font-size:12.5px; color:#5B6CFF; font-weight:700}

    .brand-tag{
      font-size:12.5px; font-weight:900; color:#111827;
    }
    .muted{color:var(--muted); font-size:12.5px; font-weight:700}
    .exp-date{font-size:12.5px; font-weight:900}

    .days{
      font-size:13px; font-weight:900;
      display:flex; align-items:center; gap:8px;
    }
    .badge{
      font-size:11px; font-weight:900; letter-spacing:.4px;
      padding:5px 9px; border-radius:999px; border:1px solid;
      display:inline-flex; align-items:center; gap:6px;
      white-space:nowrap;
    }
    .badge.safe{color:#0F766E; background:#ECFDF3; border-color:#A7F3D0}
    .badge.soon{color:#1D4ED8; background:#EFF6FF; border-color:#BFDBFE}
    .badge.h3{color:#92400E; background:#FFFBEB; border-color:#FDE68A}
    .badge.h2{color:#9A3412; background:#FFF7ED; border-color:#FED7AA}
    .badge.h1{color:#991B1B; background:#FEF2F2; border-color:#FECACA}
    .badge.expired{color:#991B1B; background:#FFF1F2; border-color:#FECDD3}

    .actions{
      display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;
    }

    .footer{
      margin-top:14px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
    }
    .footer b{color:#111827}

    /* tiny helpers */
    .hide{display:none !important}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">RDR</div>
        <div>
          <h1>RDR Hosting Reminder</h1>
          <div class="sub">Our Hosting List â€¢ {{ now.strftime('%d %B %Y - %H:%M WIB') }}</div>
        </div>
      </div>

      <div class="stats">
        <div class="stat"><span class="dot success"></span>Total: <b>{{ subs|length }}</b></div>
        <div class="stat"><span class="dot warn"></span>Expiring â‰¤7d: <b>{{ expiring_soon }}</b></div>
        <div class="stat"><span class="dot danger"></span>Expired: <b>{{ expired_count }}</b></div>
        <div class="stat">Brands: <b>{{ grouped|length }}</b></div>
      </div>

      <div class="right-actions">
        <button class="btn primary" onclick="location.href='/trigger'">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          Send to Telegram
        </button>
        <button class="btn ghost" onclick="refreshPage()">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 12a9 9 0 1 0 3-6.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M3 4v6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          Refresh
        </button>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT: FORM -->
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title" id="formTitle">Add New Subscription</div>
            <div class="card-sub" id="formSub">Input service, brand, URL, and expiry date</div>
          </div>
        </div>

        <div class="form-body">
          <form id="subForm" method="post" action="/add">
            <input type="hidden" id="editId" value="">
            <input type="hidden" id="expires_at_hidden" name="expires_at" value="">

            <div class="field">
              <div class="label">Service Name</div>
              <input id="name" name="name" placeholder="ex: VPS Namecheap Prosehat" required />
            </div>

            <div class="field">
              <div class="label">URL</div>
              <input id="url" name="url" placeholder="https://example.com" required />
            </div>

            <div class="field">
              <div class="label">Brand Domain (optional)</div>
              <input id="brand" name="brand" placeholder="ex: RADAR138" />
            </div>

            <div class="field">
              <div class="label">Expire Date</div>
              <input id="expires_at_ui" type="date" required />
              <div class="quick">
                <div class="chip" onclick="addDays(7)">+7 days</div>
                <div class="chip" onclick="addDays(14)">+14 days</div>
                <div class="chip" onclick="addDays(30)">+30 days</div>
                <div class="chip" onclick="addYears(1)">+1 year</div>
              </div>
              <div class="muted" style="margin-top:5px">
                Tanggal akan tersimpan format mm/dd/YYYY sesuai database kamu.
              </div>
            </div>

            <div class="form-actions">
              <button class="btn primary" type="submit" id="saveBtn">
                <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M5 12l4 4L19 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                Save Subscription
              </button>
              <button class="btn ghost hide" type="button" id="cancelBtn" onclick="cancelEdit()">
                <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                Cancel Edit
              </button>
            </div>

          </form>
        </div>
      </div>

      <!-- RIGHT: LIST -->
      <div class="card">
        <div class="card-head" style="padding-bottom:6px">
          <div>
            <div class="card-title">Subscriptions</div>
            <div class="card-sub">Manage all your hosting services</div>
          </div>
        </div>

        <!-- FILTERS -->
        <div class="filters">
          <div class="filter active" data-filter="all" onclick="setFilter('all')">All</div>
          <div class="filter" data-filter="safe" onclick="setFilter('safe')">Safe</div>
          <div class="filter" data-filter="soon" onclick="setFilter('soon')">Soon â‰¤7</div>
          <div class="filter" data-filter="h3" onclick="setFilter('h3')">H-3</div>
          <div class="filter" data-filter="h2" onclick="setFilter('h2')">H-2</div>
          <div class="filter" data-filter="h1" onclick="setFilter('h1')">H-1 / Today</div>
          <div class="filter" data-filter="expired" onclick="setFilter('expired')">Expired</div>
        </div>

        <div class="list-body">

          {% if not subs %}
            <div style="padding:18px;color:var(--muted);font-weight:700">
              Belum ada subscription, bro.
            </div>
          {% endif %}

          {% for brand, items in grouped.items() %}
          <div class="brand-block" data-brand="{{ brand }}">
            <div class="brand-head">
              <div class="brand-name">{{ brand or "No Brand" }}</div>
              <div class="brand-count">{{ items|length }} item{{ '' if items|length==1 else 's' }}</div>
            </div>

            {% for sub in items %}
              {% set days = (sub.expires_at - now.date()).days %}
              {% if days < 0 %}
                {% set status = "expired" %}
                {% set badge_class = "expired" %}
                {% set badge_text = "EXPIRED" %}
                {% set days_text = "Sudah Expired " ~ (-days) ~ " Hari" %}
                {% set days_color = "var(--danger)" %}
              {% elif days == 0 or days == 1 %}
                {% set status = "h1" %}
                {% set badge_class = "h1" %}
                {% set badge_text = "H-1/TODAY" %}
                {% set days_text = days ~ " day" %}
                {% set days_color = "var(--danger)" %}
              {% elif days <= 2 %}
                {% set status = "h2" %}
                {% set badge_class = "h2" %}
                {% set badge_text = "H-2" %}
                {% set days_text = days ~ " days" %}
                {% set days_color = "var(--warn)" %}
              {% elif days <= 3 %}
                {% set status = "h3" %}
                {% set badge_class = "h3" %}
                {% set badge_text = "H-3" %}
                {% set days_text = days ~ " days" %}
                {% set days_color = "var(--warn)" %}
              {% elif days <= 7 %}
                {% set status = "soon" %}
                {% set badge_class = "soon" %}
                {% set badge_text = "SOON" %}
                {% set days_text = days ~ " days" %}
                {% set days_color = "var(--warn)" %}
              {% else %}
                {% set status = "safe" %}
                {% set badge_class = "safe" %}
                {% set badge_text = "SAFE" %}
                {% set days_text = days ~ " days" %}
                {% set days_color = "var(--success)" %}
              {% endif %}

              <div class="item" data-status="{{ status }}">
                <div class="no">{{ loop.index }}</div>

                <div class="svc">
                  <div class="name">{{ sub.name|e }}</div>
                  <div class="url">ðŸ”— <a href="{{ sub.url }}" target="_blank" rel="noopener">{{ sub.url }}</a></div>
                </div>

                <div class="brand-tag">{{ sub.brand or "â€“" }}</div>

                <div class="col-exp">
                  <div class="muted">Expire</div>
                  <div class="exp-date">{{ sub.expires_at.strftime('%d %B %Y') }}</div>
                </div>

                <div class="col-days days" style="color:{{ days_color }}">
                  <div>{{ days_text }}</div>
                  <div class="badge {{ badge_class }}">{{ badge_text }}</div>
                </div>

                <div class="col-actions actions">
                  <button class="btn small" type="button"
                    onclick="startEdit('{{ sub.id }}','{{ sub.name|e }}','{{ sub.url }}','{{ sub.brand or ''|e }}','{{ sub.expires_at.strftime('%m/%d/%Y') }}')">
                    <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 20h4l10-10-4-4L4 16v4z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    Edit
                  </button>

                  <!-- Quick extend (client-side prefill) -->
                  <button class="btn small success" type="button"
                    onclick="quickExtend('{{ sub.id }}','{{ sub.name|e }}','{{ sub.url }}','{{ sub.brand or ''|e }}','{{ sub.expires_at.strftime('%m/%d/%Y') }}',30)">
                    +30d
                  </button>
                  <button class="btn small success" type="button"
                    onclick="quickExtend('{{ sub.id }}','{{ sub.name|e }}','{{ sub.url }}','{{ sub.brand or ''|e }}','{{ sub.expires_at.strftime('%m/%d/%Y') }}',365)">
                    +1y
                  </button>

                  <form method="post" action="/delete/{{ sub.id }}"
                        onsubmit="return confirm('Yakin hapus subscription ini?')">
                    <button class="btn small danger" type="submit">
                      <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6V4h8v2m-1 0v14H9V6h6z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                      Delete
                    </button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
          {% endfor %}

        </div>
      </div>
    </div>

    <div class="footer">
      <div>Â© {{ now.strftime('%Y') }} <b>RDR Hosting Reminder</b> â€¢ Built for long-life monitoring</div>
    </div>

  </div>

  <script>
    function refreshPage(){ location.reload(); }

    // ===== Date helpers =====
    const uiDate = document.getElementById("expires_at_ui");
    const hiddenDate = document.getElementById("expires_at_hidden");
    const form = document.getElementById("subForm");

    function toMMDDYYYY(dateObj){
      const mm = String(dateObj.getMonth()+1).padStart(2,'0');
      const dd = String(dateObj.getDate()).padStart(2,'0');
      const yy = dateObj.getFullYear();
      return `${mm}/${dd}/${yy}`;
    }
    function fromMMDDYYYY(str){
      const [mm,dd,yy] = str.split('/').map(Number);
      return new Date(yy, mm-1, dd);
    }
    function toInputDate(dateObj){
      const mm = String(dateObj.getMonth()+1).padStart(2,'0');
      const dd = String(dateObj.getDate()).padStart(2,'0');
      const yy = dateObj.getFullYear();
      return `${yy}-${mm}-${dd}`;
    }

    function addDays(n){
      let d = uiDate.value ? new Date(uiDate.value) : new Date();
      d.setDate(d.getDate()+n);
      uiDate.value = toInputDate(d);
    }
    function addYears(n){
      let d = uiDate.value ? new Date(uiDate.value) : new Date();
      d.setFullYear(d.getFullYear()+n);
      uiDate.value = toInputDate(d);
    }

    // convert before submit
    form.addEventListener("submit", (e)=>{
      if(!uiDate.value){
        alert("Expire date wajib diisi.");
        e.preventDefault(); return;
      }
      const d = new Date(uiDate.value);
      hiddenDate.value = toMMDDYYYY(d);
    });

    // ===== Edit mode =====
    const formTitle = document.getElementById("formTitle");
    const formSub = document.getElementById("formSub");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    function startEdit(id,name,url,brand,mmddyyyy){
      document.getElementById("name").value = name;
      document.getElementById("url").value = url;
      document.getElementById("brand").value = brand || "";
      const d = fromMMDDYYYY(mmddyyyy);
      uiDate.value = toInputDate(d);

      form.action = `/update/${id}`;
      formTitle.textContent = "Edit Subscription";
      formSub.textContent = "Update data lalu Save";
      saveBtn.innerHTML = `
        <svg class="icon" viewBox="0 0 24 24" fill="none">
          <path d="M5 12l4 4L19 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Save Changes`;
      cancelBtn.classList.remove("hide");
      window.scrollTo({top:0,behavior:"smooth"});
    }

    function quickExtend(id,name,url,brand,mmddyyyy,days){
      const d = fromMMDDYYYY(mmddyyyy);
      d.setDate(d.getDate()+days);
      startEdit(id,name,url,brand,toMMDDYYYY(d));
    }

    function cancelEdit(){
      form.action = "/add";
      form.reset();
      uiDate.value = "";
      hiddenDate.value = "";
      formTitle.textContent = "Add New Subscription";
      formSub.textContent = "Input service, brand, URL, and expiry date";
      saveBtn.innerHTML = `
        <svg class="icon" viewBox="0 0 24 24" fill="none">
          <path d="M5 12l4 4L19 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Save Subscription`;
      cancelBtn.classList.add("hide");
    }

    // ===== Filters =====
    let activeFilter = "all";
    function setFilter(key){
      activeFilter = key;
      document.querySelectorAll(".filter").forEach(f=>{
        f.classList.toggle("active", f.dataset.filter===key);
      });
      document.querySelectorAll(".item").forEach(item=>{
        const st = item.dataset.status;
        item.classList.toggle("hide", !(key==="all" || st===key));
      });
    }

    // init default date today
    uiDate.value = toInputDate(new Date());
  </script>
</body>
</html>
