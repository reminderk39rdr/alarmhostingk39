<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RDR Hosting Reminder</title>

  <style>
    /* =========================
       DESIGN TOKENS (neutral SaaS)
       ========================= */
    :root{
      --bg: #f7f8fb;
      --surface: #ffffff;
      --surface-2: #f3f5f9;
      --surface-3: #eef1f6;
      --text: #0b1220;
      --text-2: #5b6475;
      --text-3: #8b95a7;
      --border: #e6e9f0;
      --ring: #4f46e5;
      --radius: 14px;
      --radius-sm: 10px;
      --shadow-sm: 0 2px 6px rgba(15,23,42,0.06);
      --shadow: 0 10px 30px rgba(15,23,42,0.08);
      --safe: #16a34a;
      --soon: #2563eb;
      --warn: #d97706;
      --danger: #dc2626;
    }
    body.dark{
      --bg: #0b0e14;
      --surface: #111521;
      --surface-2: #161b2a;
      --surface-3: #1b2133;
      --text: #e7eaf1;
      --text-2: #aab3c4;
      --text-3: #8892a6;
      --border: #232a3d;
      --shadow-sm: 0 2px 6px rgba(0,0,0,0.35);
      --shadow: 0 12px 34px rgba(0,0,0,0.55);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    a{color:#4f46e5;text-decoration:none}
    a:hover{text-decoration:underline}
    .container{
      max-width: 1180px;
      margin: 18px auto;
      padding: 0 14px;
      display:grid;
      gap:14px;
    }

    /* =========================
       TOPBAR (minimal, real SaaS)
       ========================= */
    .topbar{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius: calc(var(--radius) + 2px);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow:var(--shadow-sm);
      position:sticky;top:10px;z-index:40;
    }
    .brand{
      display:flex;align-items:center;gap:10px;min-width:max-content;
    }
    .logo{
      width:36px;height:36px;border-radius:10px;
      display:grid;place-items:center;font-weight:900;color:#fff;
      background:#111827;
      letter-spacing:.02em;
    }
    body.dark .logo{background:#e7eaf1;color:#111827}

    .brand h1{
      margin:0;font-size:16px;font-weight:900;line-height:1.1;
    }
    .brand .sub{
      font-size:12px;color:var(--text-2);font-weight:700;margin-top:2px;
    }

    .meta{
      display:flex;align-items:center;gap:6px;flex-wrap:wrap;
    }
    .meta-chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 9px;border-radius:999px;
      background:var(--surface-2);
      border:1px solid var(--border);
      font-size:12px;font-weight:800;color:var(--text-2);
      white-space:nowrap;
    }

    .actions{
      display:flex;align-items:center;gap:8px;
    }
    .btn{
      border:1px solid var(--border);
      background:var(--surface-2);
      color:var(--text);
      padding:7px 10px;border-radius:10px;
      font-size:12px;font-weight:900;
      display:inline-flex;align-items:center;gap:6px;
      cursor:pointer;transition:.12s ease;
      line-height:1;
    }
    .btn:hover{transform:translateY(-1px);background:var(--surface-3)}
    .btn-primary{
      background:#111827;color:#fff;border-color:#111827;
    }
    body.dark .btn-primary{
      background:#e7eaf1;color:#111827;border-color:#e7eaf1;
    }
    .btn-danger{
      background:#ef4444;color:#fff;border-color:#ef4444;
    }

    /* dropdown */
    .dropdown{position:relative;}
    .dropdown-menu{
      position:absolute;right:0;top:calc(100% + 8px);
      min-width:220px;background:var(--surface);
      border:1px solid var(--border);border-radius:12px;
      box-shadow:var(--shadow);
      padding:6px;display:none;z-index:90;
    }
    .dropdown-menu.show{display:block;}
    .dropdown-item{
      width:100%;display:flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:9px;
      font-size:13px;font-weight:800;color:var(--text);
      text-decoration:none;background:transparent;border:none;cursor:pointer;
    }
    .dropdown-item:hover{background:var(--surface-2);}
    .divider{height:1px;background:var(--border);margin:6px 2px;}
    .dropdown-form input[type="file"]{display:none;}
    .file-line{
      justify-content:space-between;
    }
    .file-name{
      font-size:11px;font-weight:800;color:var(--text-3);
      max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }

    @media (max-width:900px){
      .topbar{flex-wrap:wrap;}
      .meta{width:100%;}
      .actions{width:100%;justify-content:flex-end;}
      .dropdown-menu{left:0;right:auto;}
    }

    /* =========================
       CARDS
       ========================= */
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow-sm);
    }
    .row{
      display:grid;grid-template-columns: 420px 1fr;gap:14px;align-items:start;
    }
    @media(max-width:980px){.row{grid-template-columns:1fr;}}

    .title{
      font-size:15px;font-weight:900;margin:0 0 2px 0;
    }
    .sub{
      font-size:12px;color:var(--text-2);font-weight:700;
    }

    /* scheduler health */
    .health-grid{
      margin-top:10px;
      display:grid;gap:6px;
    }
    .health-row{
      display:flex;justify-content:space-between;align-items:center;
      padding:8px 10px;border-radius:10px;background:var(--surface-2);
      border:1px solid var(--border);
      font-size:13px;font-weight:800;
    }
    .health-row span:first-child{color:var(--text-2);font-weight:900;font-size:12px;}
    .dot{
      width:8px;height:8px;border-radius:999px;background:#10b981;display:inline-block;margin-right:6px;
    }

    /* =========================
       FORM
       ========================= */
    .form-head{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .filters{display:flex;gap:6px;flex-wrap:wrap;}
    .filter{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);background:var(--surface-2);
      font-size:12px;font-weight:900;cursor:pointer;
      color:var(--text-2);
    }
    .filter.active{
      background:#111827;color:#fff;border-color:#111827;
    }
    body.dark .filter.active{background:#e7eaf1;color:#111827;border-color:#e7eaf1;}

    .form-grid{
      margin-top:10px;
      display:grid;grid-template-columns:1.2fr 1.2fr .9fr .7fr;
      gap:10px;align-items:center;
    }
    .form-grid input{
      width:100%;
      padding:12px 12px;border-radius:12px;
      border:1px solid var(--border);background:var(--surface);
      font-size:14px;font-weight:800;color:var(--text);
      outline:none;
    }
    .form-grid input:focus{
      border-color:var(--ring);
      box-shadow:0 0 0 3px rgba(79,70,229,.12);
    }
    .quick{
      grid-column:1/-1;display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;
    }
    .chip{
      padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;
      background:var(--surface-2);border:1px solid var(--border);
      cursor:pointer;color:var(--text-2);
    }
    .chip:hover{background:var(--surface-3)}
    .form-actions{
      grid-column:1/-1;display:flex;gap:8px;margin-top:6px;
    }

    @media(max-width:980px){.form-grid{grid-template-columns:1fr 1fr}}
    @media(max-width:640px){.form-grid{grid-template-columns:1fr}}

    /* =========================
       TABLE (compact, human)
       ========================= */
    table{width:100%;border-collapse:separate;border-spacing:0 8px;}
    thead th{
      font-size:11px;text-transform:uppercase;letter-spacing:.04em;
      color:var(--text-3);font-weight:900;padding:6px 10px;text-align:left;
    }
    tbody tr{
      background:var(--surface);
      border:1px solid var(--border);
    }
    tbody td{
      padding:10px;vertical-align:middle;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      font-weight:800;font-size:14px;
    }
    tbody tr td:first-child{
      border-left:1px solid var(--border);
      border-top-left-radius:12px;border-bottom-left-radius:12px;
      width:56px;color:var(--text-2);font-weight:900;
    }
    tbody tr td:last-child{
      border-right:1px solid var(--border);
      border-top-right-radius:12px;border-bottom-right-radius:12px;
    }
    tbody tr:hover{background:var(--surface-2)}

    .service{
      font-weight:900;font-size:14px;
    }
    .brand-pill{
      display:inline-flex;align-items:center;
      padding:4px 8px;border-radius:999px;
      background:var(--surface-2);border:1px solid var(--border);
      font-size:12px;font-weight:900;color:var(--text-2);
    }

    .days{
      display:flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .days-num{font-weight:900;}
    .days-neg{color:var(--danger)}
    .days-pos{color:var(--safe)}
    .status{
      padding:4px 8px;border-radius:999px;font-size:11px;font-weight:900;border:1px solid transparent;
    }
    .st-safe{background:rgba(22,163,74,.10);color:#166534;border-color:rgba(22,163,74,.25)}
    .st-soon{background:rgba(37,99,235,.10);color:#1d4ed8;border-color:rgba(37,99,235,.25)}
    .st-h3{background:rgba(217,119,6,.10);color:#b45309;border-color:rgba(217,119,6,.25)}
    .st-h2{background:rgba(234,179,8,.12);color:#92400e;border-color:rgba(234,179,8,.30)}
    .st-exp{background:rgba(220,38,38,.12);color:#b91c1c;border-color:rgba(220,38,38,.30)}

    .row-actions{
      display:flex;justify-content:flex-end;gap:6px;flex-wrap:wrap;
    }
    .act{
      padding:7px 9px;border-radius:10px;font-size:12px;font-weight:900;
      border:1px solid var(--border);background:var(--surface-2);cursor:pointer;
      display:inline-flex;align-items:center;gap:6px;white-space:nowrap;
    }
    .act:hover{background:var(--surface-3)}
    .act-edit{background:#111827;color:#fff;border-color:#111827;}
    body.dark .act-edit{background:#e7eaf1;color:#111827;border-color:#e7eaf1;}
    .act-green{background:#16a34a;color:#fff;border-color:#16a34a;}
    .act-blue{background:#2563eb;color:#fff;border-color:#2563eb;}
    .act-red{background:#ef4444;color:#fff;border-color:#ef4444;}

    /* =========================
       LOGS
       ========================= */
    .logs-head{
      display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:6px;
    }
    .level{
      padding:4px 8px;border-radius:999px;font-size:11px;font-weight:900;
      display:inline-flex;align-items:center;gap:6px;
    }
    .lv-info{background:rgba(37,99,235,.10);color:#1d4ed8;border:1px solid rgba(37,99,235,.25)}
    .lv-warn{background:rgba(217,119,6,.12);color:#b45309;border:1px solid rgba(217,119,6,.30)}
    .lv-error{background:rgba(220,38,38,.12);color:#b91c1c;border:1px solid rgba(220,38,38,.30)}

    /* =========================
       FOOTER
       ========================= */
    footer{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px 14px;
      display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;
      font-size:12px;font-weight:900;color:var(--text-2);
      box-shadow:var(--shadow-sm);
    }
    .foot-right{
      display:flex;align-items:center;gap:6px;flex-wrap:wrap;
    }
    .foot-chip{
      padding:4px 8px;border-radius:999px;background:var(--surface-2);
      border:1px solid var(--border);font-size:11px;font-weight:900;color:var(--text);
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- ================= TOPBAR ================= -->
    <header class="topbar">
      <div class="brand">
        <div class="logo">RDR</div>
        <div>
          <h1>Hosting Reminder</h1>
          <div class="sub">Keep subscriptions under control</div>
        </div>
      </div>

      <div class="meta">
        <div class="meta-chip">üë§ {{ username }}</div>
        <div class="meta-chip">üïò {{ now.strftime('%d %B %Y - %H:%M WIB') }}</div>
      </div>

      <div class="actions">
        <button class="btn" type="button" onclick="toggleDark()">üåô Theme</button>

        <div class="dropdown">
          <button class="btn btn-primary" type="button" onclick="toggleDropdown(event)">
            Tools ‚ñæ
          </button>
          <div id="toolsMenu" class="dropdown-menu">
            <a class="dropdown-item" href="/telegram-test">üì® Test Telegram</a>
            <a class="dropdown-item" href="/trigger">üìú Send Full List</a>
            <a class="dropdown-item" href="/export">‚¨áÔ∏è Export CSV</a>
            <div class="divider"></div>

            <form action="/import" method="post" enctype="multipart/form-data" class="dropdown-form">
              <input id="csvfile" type="file" name="file" accept=".csv" required onchange="showFileName(this)">
              <label for="csvfile" class="dropdown-item file-line">
                üìÅ Choose CSV
                <span id="fileName" class="file-name">No file</span>
              </label>
              <button class="dropdown-item" style="font-weight:900" type="submit">‚¨ÜÔ∏è Import Now</button>
            </form>
          </div>
        </div>

        <a class="btn btn-danger" href="/logout">Logout</a>
      </div>
    </header>

    <!-- ================= HEALTH + OVERVIEW ================= -->
    <section class="row">
      <div class="card">
        <div class="title"><span class="dot"></span>Scheduler Health</div>
        <div class="sub">Latest reminder runs</div>

        <div class="health-grid">
          <div class="health-row"><span>Daily</span><span>{{ health.daily or "-" }}</span></div>
          <div class="health-row"><span>H-3</span><span>{{ health.h3 or "-" }}</span></div>
          <div class="health-row"><span>H-2</span><span>{{ health.h2 or "-" }}</span></div>
          <div class="health-row"><span>H-1 / Expired</span><span>{{ health.h1 or "-" }}</span></div>
        </div>
      </div>

      <div class="card">
        <div class="title">Overview</div>
        <div class="sub" style="margin-top:4px">
          Total <b>{{ subs|length }}</b> subscription(s) ‚Ä¢
          Expiring ‚â§7d <b>{{ expiring_soon }}</b> ‚Ä¢
          Expired <b>{{ expired_count }}</b>
        </div>
      </div>
    </section>

    <!-- ================= FORM ================= -->
    <section class="card">
      <div class="form-head">
        <div>
          <h2 id="form-title" class="title" style="font-size:18px;margin:0">Add New Subscription</h2>
          <div class="sub">Insert service, brand, and expiry date</div>
        </div>

        <div class="filters">
          <button class="filter active" type="button" data-filter="all">All</button>
          <button class="filter" type="button" data-filter="safe">Safe</button>
          <button class="filter" type="button" data-filter="soon">Soon ‚â§7</button>
          <button class="filter" type="button" data-filter="h3">H-3</button>
          <button class="filter" type="button" data-filter="h2">H-2</button>
          <button class="filter" type="button" data-filter="h1">H-1/Today</button>
          <button class="filter" type="button" data-filter="expired">Expired</button>
        </div>
      </div>

      <form id="subscription-form" method="post" action="/add" class="form-grid">
        <input id="name" name="name" type="text" placeholder="Service Name" required>
        <input id="url" name="url" type="url" placeholder="https://example.com" required>
        <input id="brand" name="brand" type="text" placeholder="Brand / Group (optional)">
        <input id="expires_at" name="expires_at" type="date" required>

        <div class="quick">
          <button type="button" class="chip" onclick="addDays(7)">+7d</button>
          <button type="button" class="chip" onclick="addDays(14)">+14d</button>
          <button type="button" class="chip" onclick="addDays(30)">+30d</button>
          <button type="button" class="chip" onclick="addYears(1)">+1y</button>
        </div>

        <div class="form-actions">
          <button id="submit-btn" type="submit" class="btn btn-primary" style="padding:10px 14px">Save</button>
          <button id="cancel-btn" type="button" class="btn" onclick="resetForm()" style="display:none;padding:10px 14px">
            Cancel Edit
          </button>
        </div>
      </form>
    </section>

    <!-- ================= LIST BY BRAND ================= -->
    {% for brand, items in grouped.items() %}
    <section class="card">
      <div class="title" style="margin-bottom:6px">{{ brand }}</div>

      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Service</th>
            <th style="width:140px">Brand</th>
            <th>URL</th>
            <th style="width:170px">Expire Date</th>
            <th style="width:170px">Days Left</th>
            <th style="width:280px;text-align:right">Actions</th>
          </tr>
        </thead>

        <tbody>
        {% for sub in items %}
          {% set days_left = (sub.expires_at - today).days %}
          <tr class="sub-row" data-days-left="{{ days_left }}">
            <td>{{ loop.index }}</td>

            <td>
              <div class="service">{{ sub.name }}</div>
            </td>

            <td>
              <span class="brand-pill">{{ sub.brand or "No Brand" }}</span>
            </td>

            <td>
              <a href="{{ sub.url }}" target="_blank">{{ sub.url }}</a>
            </td>

            <td>{{ sub.expires_at.strftime('%d %B %Y') }}</td>

            <td>
              <div class="days">
                <span class="days-num {{ 'days-neg' if days_left < 0 else 'days-pos' }}">
                  {{ days_left }}d
                </span>

                {% if days_left < 0 %}
                  <span class="status st-exp">EXPIRED</span>
                {% elif days_left <= 1 %}
                  <span class="status st-h2">H-1/TODAY</span>
                {% elif days_left == 2 %}
                  <span class="status st-h2">H-2</span>
                {% elif days_left == 3 %}
                  <span class="status st-h3">H-3</span>
                {% elif days_left <= 7 %}
                  <span class="status st-soon">SOON</span>
                {% else %}
                  <span class="status st-safe">SAFE</span>
                {% endif %}
              </div>
            </td>

            <td style="text-align:right">
              <div class="row-actions">
                <button class="act act-edit"
                  onclick="editSubscription('{{ sub.id }}','{{ sub.name|escape }}','{{ sub.url|escape }}','{{ sub.brand|default('', true)|escape }}','{{ sub.expires_at }}')">
                  ‚úèÔ∏è Edit
                </button>

                <form method="post" action="/extend/{{ sub.id }}/30" style="display:inline">
                  <button class="act act-green" type="submit">+30d</button>
                </form>

                <form method="post" action="/extend/{{ sub.id }}/365" style="display:inline">
                  <button class="act act-green" type="submit">+1y</button>
                </form>

                <form method="post" action="/archive/{{ sub.id }}" style="display:inline">
                  <button class="act act-blue" type="submit">Archive</button>
                </form>

                <form method="post" action="/delete/{{ sub.id }}" style="display:inline"
                      onsubmit="return confirm('Delete this subscription?')">
                  <button class="act act-red" type="submit">Delete</button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </section>
    {% endfor %}

    <!-- ================= LOGS ================= -->
    <section class="card">
      <div class="logs-head">
        <div>
          <div class="title">Logs Terbaru</div>
          <div class="sub">Last 200 events</div>
        </div>
        <div class="meta-chip">Showing last 200</div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:180px">Waktu</th>
            <th style="width:120px">Level</th>
            <th>Pesan</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
          <tr>
            <td style="font-size:12px;color:var(--text-2)">{{ log.created_at }}</td>
            <td>
              {% if log.level == "ERROR" %}
                <span class="level lv-error">ERROR</span>
              {% elif log.level == "WARN" %}
                <span class="level lv-warn">WARN</span>
              {% else %}
                <span class="level lv-info">INFO</span>
              {% endif %}
            </td>
            <td>{{ log.message }}</td>
          </tr>
          {% else %}
          <tr><td colspan="3" style="text-align:center;color:var(--text-3)">Belum ada logs.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- ================= FOOTER ================= -->
    <footer>
      <div>RDR Hosting Reminder ‚Ä¢ v1.0 Premium ‚Ä¢ ¬© {{ now.strftime('%Y') }}</div>
      <div class="foot-right">
        <span class="foot-chip">Asia/Jakarta (WIB)</span>
        <span class="foot-chip">Telegram Enabled</span>
        <span class="foot-chip">{{ subs|length }} Items</span>
      </div>
    </footer>

  </div>

  <script>
    /* ========== Dropdown ========== */
    function toggleDropdown(e){
      e.stopPropagation();
      const menu = document.getElementById("toolsMenu");
      menu.classList.toggle("show");
    }
    document.addEventListener("click", ()=>{
      const menu = document.getElementById("toolsMenu");
      if(menu) menu.classList.remove("show");
    });
    function showFileName(input){
      document.getElementById("fileName").textContent =
        input.files?.[0]?.name || "No file";
    }

    /* ========== Dark mode ========== */
    function toggleDark(){
      document.body.classList.toggle("dark");
      localStorage.setItem("rdr-dark", document.body.classList.contains("dark") ? "1":"0");
    }
    if(localStorage.getItem("rdr-dark")==="1"){document.body.classList.add("dark");}

    /* ========== Quick add expiry ========== */
    function addDays(n){
      const el = document.getElementById("expires_at");
      const base = el.value ? new Date(el.value) : new Date();
      base.setDate(base.getDate() + n);
      el.value = base.toISOString().slice(0,10);
    }
    function addYears(n){
      const el = document.getElementById("expires_at");
      const base = el.value ? new Date(el.value) : new Date();
      base.setFullYear(base.getFullYear() + n);
      el.value = base.toISOString().slice(0,10);
    }

    /* ========== Edit mode hook to backend ========== */
    function editSubscription(id, name, url, brand, expires){
      const form = document.getElementById("subscription-form");
      form.action = "/update/" + id;

      document.getElementById("name").value = name;
      document.getElementById("url").value = url;
      document.getElementById("brand").value = brand || "";
      document.getElementById("expires_at").value = expires;

      document.getElementById("form-title").innerText = "Edit Subscription";
      document.getElementById("submit-btn").innerText = "Update";
      document.getElementById("cancel-btn").style.display = "inline-flex";
      window.scrollTo({top:0,behavior:"smooth"});
    }

    function resetForm(){
      const form = document.getElementById("subscription-form");
      form.action = "/add";
      form.reset();
      document.getElementById("form-title").innerText = "Add New Subscription";
      document.getElementById("submit-btn").innerText = "Save";
      document.getElementById("cancel-btn").style.display = "none";
    }
    resetForm();

    /* ========== Client-side filter by days_left ========== */
    document.querySelectorAll(".filter").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".filter").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const f = btn.dataset.filter;

        document.querySelectorAll("[data-days-left]").forEach(row=>{
          const d = parseInt(row.dataset.daysLeft || row.getAttribute("data-days-left"),10);
          let show = true;
          if(f==="safe") show = d>7;
          if(f==="soon") show = d>=1 && d<=7;
          if(f==="h3") show = d===3;
          if(f==="h2") show = d===2;
          if(f==="h1") show = d<=1 && d>=0;
          if(f==="expired") show = d<0;
          if(f==="all") show = true;
          row.style.display = show ? "" : "none";
        });
      });
    });
  </script>
</body>
</html>
